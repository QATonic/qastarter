package {{config.packageName}}.core;

import io.github.bonigarcia.wdm.WebDriverManager;
import org.openqa.selenium.WebDriver;
import org.openqa.selenium.chrome.ChromeDriver;
import org.openqa.selenium.chrome.ChromeOptions;
import org.openqa.selenium.firefox.FirefoxDriver;
import org.openqa.selenium.firefox.FirefoxOptions;
import org.openqa.selenium.edge.EdgeDriver;
import org.openqa.selenium.edge.EdgeOptions;
{{#if dependencies.includes "Logging"}}
import org.apache.logging.log4j.LogManager;
import org.apache.logging.log4j.Logger;
{{/if}}

import java.time.Duration;

/**
 * WebDriverManager - Manages WebDriver instances with proper configuration
 * 
 * Features:
 * - Automatic driver management using WebDriverManager
 * - Support for Chrome, Firefox, and Edge browsers
 * - Headless mode support for CI/CD environments
 * - ThreadLocal for parallel test execution
 * - Configurable timeouts and options
 * 
 * @author QAStarter
 * @version 1.0
 */
public class DriverManager {
    
    {{#if dependencies.includes "Logging"}}
    private static final Logger logger = LogManager.getLogger(DriverManager.class);
    {{/if}}
    
    private static final ThreadLocal<WebDriver> driverThreadLocal = new ThreadLocal<>();
    
    // Configuration properties
    private static final String DEFAULT_BROWSER = "chrome";
    private static final boolean DEFAULT_HEADLESS = false;
    private static final int DEFAULT_TIMEOUT = 30;
    private static final int DEFAULT_PAGE_LOAD_TIMEOUT = 30;
    
    /**
     * Private constructor to prevent instantiation
     */
    private DriverManager() {
        throw new IllegalStateException("Utility class");
    }
    
    /**
     * Initialize WebDriver based on browser type and configuration
     * 
     * @param browserType Browser type (chrome, firefox, edge)
     * @param headless Whether to run in headless mode
     * @return WebDriver instance
     */
    public static WebDriver initializeDriver(String browserType, boolean headless) {
        String browser = (browserType != null) ? browserType.toLowerCase() : DEFAULT_BROWSER;
        
        {{#if dependencies.includes "Logging"}}
        logger.info("Initializing {} driver with headless mode: {}", browser, headless);
        {{/if}}
        
        WebDriver driver;
        
        switch (browser) {
            case "chrome":
                driver = createChromeDriver(headless);
                break;
            case "firefox":
                driver = createFirefoxDriver(headless);
                break;
            case "edge":
                driver = createEdgeDriver(headless);
                break;
            default:
                {{#if dependencies.includes "Logging"}}
                logger.warn("Unknown browser type: {}. Defaulting to Chrome.", browser);
                {{/if}}
                driver = createChromeDriver(headless);
        }
        
        // Configure driver timeouts
        configureDriver(driver);
        
        // Store in ThreadLocal for thread safety
        driverThreadLocal.set(driver);
        
        {{#if dependencies.includes "Logging"}}
        logger.info("Driver initialized successfully: {}", driver.getClass().getSimpleName());
        {{/if}}
        
        return driver;
    }
    
    /**
     * Initialize WebDriver with system properties
     * 
     * @return WebDriver instance
     */
    public static WebDriver initializeDriver() {
        String browser = System.getProperty("browser", DEFAULT_BROWSER);
        boolean headless = Boolean.parseBoolean(System.getProperty("headless", String.valueOf(DEFAULT_HEADLESS)));
        
        return initializeDriver(browser, headless);
    }
    
    /**
     * Get current WebDriver instance from ThreadLocal
     * 
     * @return Current WebDriver instance
     */
    public static WebDriver getDriver() {
        WebDriver driver = driverThreadLocal.get();
        if (driver == null) {
            {{#if dependencies.includes "Logging"}}
            logger.warn("No driver found in ThreadLocal. Initializing new driver.");
            {{/if}}
            return initializeDriver();
        }
        return driver;
    }
    
    /**
     * Quit WebDriver and clean up ThreadLocal
     */
    public static void quitDriver() {
        WebDriver driver = driverThreadLocal.get();
        if (driver != null) {
            {{#if dependencies.includes "Logging"}}
            logger.info("Quitting WebDriver: {}", driver.getClass().getSimpleName());
            {{/if}}
            driver.quit();
            driverThreadLocal.remove();
        }
    }
    
    /**
     * Create Chrome WebDriver with options
     * 
     * @param headless Whether to run in headless mode
     * @return ChromeDriver instance
     */
    private static WebDriver createChromeDriver(boolean headless) {
        WebDriverManager.chromedriver().setup();
        
        ChromeOptions options = new ChromeOptions();
        
        // Basic options
        options.addArguments("--disable-dev-shm-usage");
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-gpu");
        options.addArguments("--window-size=1920,1080");
        options.addArguments("--disable-extensions");
        options.addArguments("--disable-web-security");
        options.addArguments("--allow-running-insecure-content");
        
        // Headless mode
        if (headless) {
            options.addArguments("--headless=new");
        }
        
        // Performance optimizations
        options.addArguments("--disable-background-timer-throttling");
        options.addArguments("--disable-backgrounding-occluded-windows");
        options.addArguments("--disable-renderer-backgrounding");
        
        return new ChromeDriver(options);
    }
    
    /**
     * Create Firefox WebDriver with options
     * 
     * @param headless Whether to run in headless mode
     * @return FirefoxDriver instance
     */
    private static WebDriver createFirefoxDriver(boolean headless) {
        WebDriverManager.firefoxdriver().setup();
        
        FirefoxOptions options = new FirefoxOptions();
        
        // Basic options
        options.addArguments("--width=1920");
        options.addArguments("--height=1080");
        
        // Headless mode
        if (headless) {
            options.addArguments("--headless");
        }
        
        return new FirefoxDriver(options);
    }
    
    /**
     * Create Edge WebDriver with options
     * 
     * @param headless Whether to run in headless mode
     * @return EdgeDriver instance
     */
    private static WebDriver createEdgeDriver(boolean headless) {
        WebDriverManager.edgedriver().setup();
        
        EdgeOptions options = new EdgeOptions();
        
        // Basic options
        options.addArguments("--disable-dev-shm-usage");
        options.addArguments("--no-sandbox");
        options.addArguments("--disable-gpu");
        options.addArguments("--window-size=1920,1080");
        
        // Headless mode
        if (headless) {
            options.addArguments("--headless");
        }
        
        return new EdgeDriver(options);
    }
    
    /**
     * Configure WebDriver timeouts and settings
     * 
     * @param driver WebDriver instance to configure
     */
    private static void configureDriver(WebDriver driver) {
        // Implicit wait
        driver.manage().timeouts().implicitlyWait(Duration.ofSeconds(DEFAULT_TIMEOUT));
        
        // Page load timeout
        driver.manage().timeouts().pageLoadTimeout(Duration.ofSeconds(DEFAULT_PAGE_LOAD_TIMEOUT));
        
        // Script timeout
        driver.manage().timeouts().scriptTimeout(Duration.ofSeconds(DEFAULT_TIMEOUT));
        
        // Maximize window (if not headless)
        String headless = System.getProperty("headless", "false");
        if (!"true".equalsIgnoreCase(headless)) {
            driver.manage().window().maximize();
        }
    }
    
    /**
     * Check if WebDriver is initialized
     * 
     * @return true if driver is initialized, false otherwise
     */
    public static boolean isDriverInitialized() {
        return driverThreadLocal.get() != null;
    }
} 