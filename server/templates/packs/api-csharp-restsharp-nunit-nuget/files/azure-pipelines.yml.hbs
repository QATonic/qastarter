trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  DOTNET_VERSION: '{{toolVersions.dotnet}}'
  ENVIRONMENT: 'qa'

stages:
  - stage: Test
    displayName: 'Run API Tests'
    jobs:
      - job: TestJob
        displayName: 'Execute Tests'
        strategy:
          matrix:
            QA_Environment:
              ENVIRONMENT: 'qa'
            Dev_Environment:
              ENVIRONMENT: 'dev'
        steps:
          - task: Cache@2
            inputs:
              key: 'nuget | "$(Agent.OS)" | **/*.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)"
                nuget
              path: $(NUGET_PACKAGES)
            displayName: 'Cache NuGet packages'
          
          - task: UseDotNet@2
            inputs:
              version: '$(DOTNET_VERSION)'
              packageType: 'sdk'
            displayName: 'Install .NET SDK'
          
          - script: dotnet restore
            displayName: 'Restore NuGet packages'
          
          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build project'
          
          - script: |
              dotnet test --configuration Release --no-build \
                --logger "trx;LogFileName=test-results.trx" \
                --logger "html;LogFileName=test-results.html" \
                --results-directory $(Build.SourcesDirectory)/TestResults \
                -e ENVIRONMENT=$(ENVIRONMENT)
            displayName: 'Run API Tests'
            env:
              ENVIRONMENT: $(ENVIRONMENT)
          
          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/TestResults/*.trx'
              testRunTitle: 'API Tests - $(ENVIRONMENT)'
            displayName: 'Publish Test Results'
          
          {{#if (eq reportingTool "allure")}}
          - script: |
              wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
              tar -zxf allure-2.25.0.tgz -C /opt/
              sudo ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
            displayName: 'Install Allure CLI'
            condition: always()
          
          - script: |
              allure generate allure-results --clean -o allure-report
            displayName: 'Generate Allure report'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-results'
              ArtifactName: 'allure-results-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish Allure results'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-report'
              ArtifactName: 'allure-report-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish Allure report'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "extent-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults/extent-reports'
              ArtifactName: 'extent-reports-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish ExtentReports'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "nunit-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults'
              ArtifactName: 'nunit-reports-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish NUnit Reports'
            condition: always()
          {{/if}}
