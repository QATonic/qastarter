variables:
  MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository"
  MAVEN_CLI_OPTS: "--batch-mode --errors --fail-at-end --show-version"
  ENVIRONMENT: "qa"

image: maven:3.9-eclipse-temurin-11

cache:
  paths:
    - .m2/repository/
    - target/

stages:
  - test
  - report

test:
  stage: test
  script:
    - mvn $MAVEN_CLI_OPTS clean test {{#if (eq testingPattern "bdd")}}-Dincludes="**/runners/*TestRunner.java"{{else}}-Denvironment=$ENVIRONMENT{{/if}}
  artifacts:
    when: always
    paths:
      - target/surefire-reports/
      {{#if (eq reportingTool "allure")}}
      - target/allure-results/
      {{/if}}
      {{#if (eq reportingTool "extentreports")}}
      - test-output/extent-reports/
      {{/if}}
    expire_in: 30 days
  only:
    - main
    - develop
    - merge_requests
  variables:
    TEST_ENV: qa

{{#if (eq reportingTool "allure")}}
generate_allure_report:
  stage: report
  image: maven:3.9-eclipse-temurin-11
  dependencies:
    - test
  before_script:
    - apt-get update && apt-get install -y wget
    - wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
    - tar -zxvf allure-2.25.0.tgz -C /opt/
    - ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
  script:
    - allure generate target/allure-results --clean -o allure-report
  artifacts:
    when: always
    paths:
      - allure-report/
    expire_in: 30 days
  only:
    - main
    - develop
{{/if}}
