trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  ENVIRONMENT: 'qa'

stages:
  - stage: Test
    displayName: 'Run API Tests'
    jobs:
      - job: TestJob
        displayName: 'Execute Tests'
        strategy:
          matrix:
            QA_Environment:
              ENVIRONMENT: 'qa'
            Dev_Environment:
              ENVIRONMENT: 'dev'
        steps:
          - task: Cache@2
            inputs:
              key: 'maven | "$(Agent.OS)" | **/pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)
            displayName: 'Cache Maven packages'
          
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean test'
              {{#if (eq testingPattern "bdd")}}
              options: '-Dincludes="**/runners/*TestRunner.java"'
              {{else}}
              options: '-Denvironment=$(ENVIRONMENT)'
              {{/if}}
              publishJUnitResults: true
              testResultsFiles: '**/surefire-reports/TEST-*.xml'
              javaHomeOption: 'JDKVersion'
              jdkVersionOption: '1.11'
              mavenVersionOption: 'Default'
              mavenOptions: '$(MAVEN_OPTS)'
            displayName: 'Run {{#if (eq testingPattern "bdd")}}Cucumber BDD{{else}}TestNG{{/if}} Tests'
            env:
              ENVIRONMENT: $(ENVIRONMENT)
          
          {{#if (eq reportingTool "allure")}}
          - script: |
              wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
              tar -zxvf allure-2.25.0.tgz -C /opt/
              sudo ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
            displayName: 'Install Allure CLI'
            condition: always()
          
          - script: |
              allure generate target/allure-results --clean -o allure-report
            displayName: 'Generate Allure report'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'target/allure-results'
              ArtifactName: 'allure-results-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish Allure results'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-report'
              ArtifactName: 'allure-report-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish Allure report'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "extentreports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'test-output/extent-reports'
              ArtifactName: 'extent-reports-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish ExtentReports'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "testng-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'target/surefire-reports'
              ArtifactName: 'testng-reports-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish TestNG Reports'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "junit-html")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'target/surefire-reports'
              ArtifactName: 'junit-html-reports-$(ENVIRONMENT)'
              publishLocation: 'Container'
            displayName: 'Publish JUnit HTML Reports'
            condition: always()
          {{/if}}
