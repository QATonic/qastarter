package {{packageName}}.utils;

import io.restassured.response.Response;
import {{packageName}}.config.ConfigurationReader;
import {{packageName}}.core.APIClient;
{{#if utilities.logger}}
import {{packageName}}.utils.Log;
{{/if}}

import java.util.HashMap;
import java.util.Map;

/**
 * Authentication manager for API testing
 * Handles various authentication mechanisms including OAuth, JWT, and API keys
 */
public class AuthenticationManager {

    private String cachedToken;
    private long tokenExpiryTime;
    private final APIClient apiClient;

    public AuthenticationManager() {
        this.apiClient = new APIClient();
    }

    /**
     * Get Bearer token for authenticated requests
     * Uses cached token if valid, otherwise requests new token
     * 
     * @return Bearer token
     */
    public String getBearerToken() {
        if (isTokenValid()) {
            {{#if utilities.logger}}
            Log.debug("Using cached Bearer token");
            {{/if}}
            return cachedToken;
        }
        
        {{#if utilities.logger}}
        Log.info("Requesting new Bearer token");
        {{/if}}
        
        return requestNewToken();
    }

    /**
     * Authenticate with username and password
     * 
     * @param username User credentials username
     * @param password User credentials password
     * @return Authentication token
     */
    public String authenticateWithCredentials(String username, String password) {
        {{#if utilities.logger}}
        Log.info("Authenticating with username: " + username);
        {{/if}}
        
        String loginEndpoint = ConfigurationReader.getProperty("auth.login.endpoint", "/auth/login");
        
        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", username);
        credentials.put("password", password);
        
        Response response = apiClient.post(loginEndpoint, credentials);
        
        if (response.getStatusCode() == 200) {
            String token = extractTokenFromResponse(response);
            cacheToken(token);
            
            {{#if utilities.logger}}
            Log.info("Authentication successful");
            {{/if}}
            
            return token;
        } else {
            {{#if utilities.logger}}
            Log.error("Authentication failed. Status code: " + response.getStatusCode());
            {{/if}}
            throw new RuntimeException("Authentication failed with status: " + response.getStatusCode());
        }
    }

    /**
     * Authenticate with API key
     * 
     * @param apiKey API key for authentication
     * @return API key for header
     */
    public String authenticateWithApiKey(String apiKey) {
        {{#if utilities.logger}}
        Log.info("Using API key authentication");
        {{/if}}
        
        // Validate API key if validation endpoint is configured
        String validationEndpoint = ConfigurationReader.getProperty("auth.apikey.validation.endpoint");
        if (validationEndpoint != null) {
            validateApiKey(apiKey, validationEndpoint);
        }
        
        return apiKey;
    }

    /**
     * Authenticate with OAuth 2.0 client credentials flow
     * 
     * @param clientId OAuth client ID
     * @param clientSecret OAuth client secret
     * @return Access token
     */
    public String authenticateWithOAuth(String clientId, String clientSecret) {
        {{#if utilities.logger}}
        Log.info("Authenticating with OAuth client credentials");
        {{/if}}
        
        String tokenEndpoint = ConfigurationReader.getProperty("auth.oauth.token.endpoint", "/oauth/token");
        
        Map<String, String> oauthRequest = new HashMap<>();
        oauthRequest.put("grant_type", "client_credentials");
        oauthRequest.put("client_id", clientId);
        oauthRequest.put("client_secret", clientSecret);
        
        // Set content type for OAuth request
        Map<String, String> headers = new HashMap<>();
        headers.put("Content-Type", "application/x-www-form-urlencoded");
        
        Response response = apiClient.post(tokenEndpoint, oauthRequest, headers);
        
        if (response.getStatusCode() == 200) {
            String token = response.jsonPath().getString("access_token");
            long expiresIn = response.jsonPath().getLong("expires_in");
            
            cacheTokenWithExpiry(token, expiresIn);
            
            {{#if utilities.logger}}
            Log.info("OAuth authentication successful");
            {{/if}}
            
            return token;
        } else {
            {{#if utilities.logger}}
            Log.error("OAuth authentication failed. Status code: " + response.getStatusCode());
            {{/if}}
            throw new RuntimeException("OAuth authentication failed with status: " + response.getStatusCode());
        }
    }

    /**
     * Request new token using configured authentication method
     * 
     * @return New authentication token
     */
    private String requestNewToken() {
        String authMethod = ConfigurationReader.getProperty("auth.method", "credentials");
        
        switch (authMethod.toLowerCase()) {
            case "credentials":
                String username = ConfigurationReader.getProperty("auth.username");
                String password = ConfigurationReader.getProperty("auth.password");
                return authenticateWithCredentials(username, password);
                
            case "oauth":
                String clientId = ConfigurationReader.getProperty("auth.oauth.client.id");
                String clientSecret = ConfigurationReader.getProperty("auth.oauth.client.secret");
                return authenticateWithOAuth(clientId, clientSecret);
                
            case "apikey":
                return ConfigurationReader.getProperty("auth.api.key");
                
            default:
                throw new RuntimeException("Unsupported authentication method: " + authMethod);
        }
    }

    /**
     * Extract token from authentication response
     * 
     * @param response Authentication response
     * @return Extracted token
     */
    private String extractTokenFromResponse(Response response) {
        String tokenField = ConfigurationReader.getProperty("auth.token.field", "token");
        
        try {
            return response.jsonPath().getString(tokenField);
        } catch (Exception e) {
            {{#if utilities.logger}}
            Log.error("Failed to extract token from response", e);
            {{/if}}
            throw new RuntimeException("Failed to extract token from response", e);
        }
    }

    /**
     * Cache authentication token
     * 
     * @param token Token to cache
     */
    private void cacheToken(String token) {
        this.cachedToken = token;
        // Default expiry time (1 hour)
        this.tokenExpiryTime = System.currentTimeMillis() + (60 * 60 * 1000);
        
        {{#if utilities.logger}}
        Log.debug("Token cached with default expiry");
        {{/if}}
    }

    /**
     * Cache authentication token with specific expiry
     * 
     * @param token Token to cache
     * @param expiresInSeconds Token expiry in seconds
     */
    private void cacheTokenWithExpiry(String token, long expiresInSeconds) {
        this.cachedToken = token;
        this.tokenExpiryTime = System.currentTimeMillis() + (expiresInSeconds * 1000);
        
        {{#if utilities.logger}}
        Log.debug("Token cached with expiry: " + expiresInSeconds + " seconds");
        {{/if}}
    }

    /**
     * Check if cached token is still valid
     * 
     * @return true if token is valid, false otherwise
     */
    private boolean isTokenValid() {
        return cachedToken != null && System.currentTimeMillis() < tokenExpiryTime;
    }

    /**
     * Validate API key
     * 
     * @param apiKey API key to validate
     * @param validationEndpoint Endpoint for validation
     */
    private void validateApiKey(String apiKey, String validationEndpoint) {
        {{#if utilities.logger}}
        Log.info("Validating API key");
        {{/if}}
        
        Map<String, String> headers = new HashMap<>();
        headers.put("X-API-Key", apiKey);
        
        Response response = apiClient.get(validationEndpoint, headers);
        
        if (response.getStatusCode() != 200) {
            {{#if utilities.logger}}
            Log.error("API key validation failed. Status code: " + response.getStatusCode());
            {{/if}}
            throw new RuntimeException("Invalid API key");
        }
        
        {{#if utilities.logger}}
        Log.info("API key validation successful");
        {{/if}}
    }

    /**
     * Clear cached token
     */
    public void clearToken() {
        this.cachedToken = null;
        this.tokenExpiryTime = 0;
        
        {{#if utilities.logger}}
        Log.debug("Authentication token cleared");
        {{/if}}
    }

    /**
     * Get cached token (for testing purposes)
     * 
     * @return Cached token
     */
    public String getCachedToken() {
        return cachedToken;
    }

    /**
     * Check if token is cached and valid
     * 
     * @return true if valid token exists
     */
    public boolean hasValidToken() {
        return isTokenValid();
    }
}