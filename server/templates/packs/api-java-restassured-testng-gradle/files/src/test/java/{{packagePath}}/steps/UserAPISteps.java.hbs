package {{packageName}}.steps;

import {{packageName}}.core.APIClient;
import {{packageName}}.core.RequestBuilder;
import {{packageName}}.core.ResponseValidator;
import {{packageName}}.models.User;
import {{packageName}}.utils.Log;
import io.cucumber.java.en.*;
import io.restassured.response.Response;
import io.restassured.module.jsv.JsonSchemaValidator;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*;

import java.io.File;
import java.util.HashMap;
import java.util.Map;

public class UserAPISteps {
    
    private APIClient apiClient;
    private RequestBuilder requestBuilder;
    private ResponseValidator validator;
    private Response response;
    private Map<String, Object> requestBody;
    
    public UserAPISteps() {
        this.apiClient = APIClient.getInstance();
        this.requestBuilder = new RequestBuilder();
        this.validator = new ResponseValidator();
        this.requestBody = new HashMap<>();
    }
    
    @Given("the API base URL is configured")
    public void the_api_base_url_is_configured() {
        Log.info("API base URL: " + apiClient.getBaseURI());
        assertThat("Base URL should not be empty", apiClient.getBaseURI(), not(emptyOrNullString()));
    }
    
    @Given("I have valid authentication credentials")
    public void i_have_valid_authentication_credentials() {
        // Set up basic authentication or token
        Log.info("Setting up authentication credentials");
        requestBuilder.addHeader("Authorization", "Bearer test-token");
    }
    
    @Given("I have user data with name {string} and email {string}")
    public void i_have_user_data_with_name_and_email(String name, String email) {
        requestBody = new HashMap<>();
        requestBody.put("name", name);
        requestBody.put("email", email);
        requestBody.put("job", "QA Automation Engineer");
        
        Log.info("Created user data: " + requestBody);
        requestBuilder.setBody(requestBody);
    }
    
    @Given("a user exists with id {string}")
    public void a_user_exists_with_id(String userId) {
        Log.info("User with ID " + userId + " should exist in the system");
        // In real scenario, you might create the user first
    }
    
    @Given("multiple users exist in the system")
    public void multiple_users_exist_in_the_system() {
        Log.info("Multiple users should exist in the system");
        // In real scenario, you might create multiple users
    }
    
    @Given("I have updated user data with name {string}")
    public void i_have_updated_user_data_with_name(String name) {
        requestBody = new HashMap<>();
        requestBody.put("name", name);
        requestBody.put("job", "Senior QA Engineer");
        
        Log.info("Created updated user data: " + requestBody);
        requestBuilder.setBody(requestBody);
    }
    
    @Given("I have user data with invalid email format")
    public void i_have_user_data_with_invalid_email_format() {
        requestBody = new HashMap<>();
        requestBody.put("name", "Test User");
        requestBody.put("email", "invalid-email-format");
        
        Log.info("Created user data with invalid email: " + requestBody);
        requestBuilder.setBody(requestBody);
    }
    
    @When("I send a POST request to {string} endpoint")
    public void i_send_a_post_request_to_endpoint(String endpoint) {
        Log.info("Sending POST request to: " + endpoint);
        response = requestBuilder.post(endpoint);
        Log.info("Response received with status code: " + response.getStatusCode());
    }
    
    @When("I send a GET request to {string} endpoint")
    public void i_send_a_get_request_to_endpoint(String endpoint) {
        Log.info("Sending GET request to: " + endpoint);
        response = requestBuilder.get(endpoint);
        Log.info("Response received with status code: " + response.getStatusCode());
    }
    
    @When("I send a PUT request to {string} endpoint")
    public void i_send_a_put_request_to_endpoint(String endpoint) {
        Log.info("Sending PUT request to: " + endpoint);
        response = requestBuilder.put(endpoint);
        Log.info("Response received with status code: " + response.getStatusCode());
    }
    
    @When("I send a DELETE request to {string} endpoint")
    public void i_send_a_delete_request_to_endpoint(String endpoint) {
        Log.info("Sending DELETE request to: " + endpoint);
        response = requestBuilder.delete(endpoint);
        Log.info("Response received with status code: " + response.getStatusCode());
    }
    
    @Then("the response status code should be {int}")
    public void the_response_status_code_should_be(Integer expectedStatusCode) {
        Log.info("Validating status code: " + expectedStatusCode);
        validator.validateStatusCode(response, expectedStatusCode);
    }
    
    @Then("the response should contain user id")
    public void the_response_should_contain_user_id() {
        Log.info("Validating user id exists in response");
        assertThat("Response should contain user id", 
                  response.jsonPath().get("id"), 
                  notNullValue());
    }
    
    @Then("the response should contain user id {string}")
    public void the_response_should_contain_user_id(String userId) {
        Log.info("Validating user id: " + userId);
        String actualId = response.jsonPath().getString("id");
        assertThat("User ID should match", actualId, equalTo(userId));
    }
    
    @Then("the response should contain name {string}")
    public void the_response_should_contain_name(String expectedName) {
        Log.info("Validating name: " + expectedName);
        String actualName = response.jsonPath().getString("name");
        assertThat("Name should match", actualName, equalTo(expectedName));
    }
    
    @Then("the response should contain email {string}")
    public void the_response_should_contain_email(String expectedEmail) {
        Log.info("Validating email: " + expectedEmail);
        String actualEmail = response.jsonPath().getString("email");
        assertThat("Email should match", actualEmail, equalTo(expectedEmail));
    }
    
    @Then("the response time should be less than {int} milliseconds")
    public void the_response_time_should_be_less_than_milliseconds(Integer maxTime) {
        long actualTime = response.getTime();
        Log.info("Response time: " + actualTime + "ms (max: " + maxTime + "ms)");
        assertThat("Response time should be within limit", 
                  actualTime, 
                  lessThan(maxTime.longValue()));
    }
    
    @Then("the response should be a list of users")
    public void the_response_should_be_a_list_of_users() {
        Log.info("Validating response is a list");
        assertThat("Response should be a list", 
                  response.jsonPath().getList("$"), 
                  notNullValue());
    }
    
    @Then("the response should contain at least {int} user")
    public void the_response_should_contain_at_least_user(Integer minUsers) {
        int actualCount = response.jsonPath().getList("$").size();
        Log.info("User count: " + actualCount + " (min: " + minUsers + ")");
        assertThat("User count should be at least " + minUsers, 
                  actualCount, 
                  greaterThanOrEqualTo(minUsers));
    }
    
    @Then("the response should contain error message")
    public void the_response_should_contain_error_message() {
        Log.info("Validating error message exists");
        assertThat("Response should contain error field", 
                  response.jsonPath().get("error"), 
                  notNullValue());
    }
    
    @Then("the response should contain validation error")
    public void the_response_should_contain_validation_error() {
        Log.info("Validating validation error exists");
        String error = response.jsonPath().getString("error");
        assertThat("Response should contain validation error", 
                  error, 
                  not(emptyOrNullString()));
    }
    
    @Then("the response should match the user schema")
    public void the_response_should_match_the_user_schema() {
        Log.info("Validating response against user schema");
        File schemaFile = new File("src/test/resources/schemas/user-schema.json");
        response.then().assertThat().body(JsonSchemaValidator.matchesJsonSchema(schemaFile));
    }
}
