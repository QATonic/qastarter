package {{packageName}}.tests;

import io.restassured.response.Response;
import org.testng.annotations.Test;
import {{packageName}}.core.BaseTest;
{{#if utilities.authManager}}
import {{packageName}}.utils.AuthenticationManager;
{{/if}}
{{#if utilities.logger}}
import {{packageName}}.utils.Log;
{{/if}}

import java.util.HashMap;
import java.util.Map;

/**
 * Authentication API test suite
 * Tests for authentication endpoints and token management
 */
public class AuthenticationTests extends BaseTest {

    private static final String LOGIN_ENDPOINT = "/auth/login";
    private static final String LOGOUT_ENDPOINT = "/auth/logout";
    private static final String PROFILE_ENDPOINT = "/auth/profile";
    private static final String REFRESH_TOKEN_ENDPOINT = "/auth/refresh";

    @Test(groups = {"auth", "smoke"}, description = "Test successful login with valid credentials")
    public void testValidLogin() {
        logStep("Testing valid user login");
        
        // Prepare login credentials
        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", "testuser");
        credentials.put("password", "testpass123");
        
        logAction("Sending login request with valid credentials");
        Response response = apiClient.post(LOGIN_ENDPOINT, credentials);
        
        // Validate successful login response
        apiClient.getResponseValidator().validateStatusCode(response, 200);
        apiClient.getResponseValidator().validateContentType(response, "application/json");
        apiClient.getResponseValidator().validateJsonFieldExists(response, "token");
        apiClient.getResponseValidator().validateJsonFieldExists(response, "expires_in");
        apiClient.getResponseValidator().validateJsonFieldNotEmpty(response, "token");
        
        // Validate token format (should be JWT-like)
        String token = response.jsonPath().getString("token");
        org.testng.Assert.assertTrue(token.contains("."), "Token should be in JWT format");
        
        logVerification("Valid login successful, token received");
    }

    @Test(groups = {"auth", "negative"}, description = "Test login with invalid credentials")
    public void testInvalidLogin() {
        logStep("Testing login with invalid credentials");
        
        // Prepare invalid credentials
        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", "invaliduser");
        credentials.put("password", "wrongpassword");
        
        logAction("Sending login request with invalid credentials");
        Response response = apiClient.post(LOGIN_ENDPOINT, credentials);
        
        // Validate error response
        apiClient.getResponseValidator().validateStatusCode(response, 401);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "error");
        apiClient.getResponseValidator().validateJsonField(response, "success", false);
        
        logVerification("Invalid login correctly rejected");
    }

    @Test(groups = {"auth", "negative"}, description = "Test login with missing credentials")
    public void testLoginWithMissingCredentials() {
        logStep("Testing login with missing credentials");
        
        // Test with missing password
        Map<String, String> incompleteCredentials = new HashMap<>();
        incompleteCredentials.put("username", "testuser");
        
        logAction("Sending login request with missing password");
        Response response = apiClient.post(LOGIN_ENDPOINT, incompleteCredentials);
        
        // Validate error response
        apiClient.getResponseValidator().validateStatusCode(response, 400);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "error");
        
        logVerification("Missing credentials correctly handled");
    }

    {{#if utilities.authManager}}
    @Test(groups = {"auth", "integration"}, description = "Test authenticated request with valid token")
    public void testAuthenticatedRequest() {
        logStep("Testing authenticated API request");
        
        // Get authentication token
        AuthenticationManager authManager = new AuthenticationManager();
        String token = authManager.authenticateWithCredentials("testuser", "testpass123");
        
        logAction("Making authenticated request to profile endpoint");
        Response response = apiClient.authenticatedGet(PROFILE_ENDPOINT, token);
        
        // Validate authenticated response
        apiClient.getResponseValidator().validateStatusCode(response, 200);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "user");
        apiClient.getResponseValidator().validateJsonFieldExists(response, "permissions");
        
        logVerification("Authenticated request successful");
    }

    @Test(groups = {"auth", "negative"}, description = "Test request with invalid token")
    public void testInvalidTokenRequest() {
        logStep("Testing request with invalid token");
        
        String invalidToken = "invalid.token.here";
        
        logAction("Making request with invalid token");
        Response response = apiClient.authenticatedGet(PROFILE_ENDPOINT, invalidToken);
        
        // Validate unauthorized response
        apiClient.getResponseValidator().validateStatusCode(response, 401);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "error");
        
        logVerification("Invalid token correctly rejected");
    }

    @Test(groups = {"auth", "negative"}, description = "Test request without token")
    public void testRequestWithoutToken() {
        logStep("Testing authenticated endpoint without token");
        
        logAction("Making request to protected endpoint without token");
        Response response = apiClient.get(PROFILE_ENDPOINT);
        
        // Validate unauthorized response
        apiClient.getResponseValidator().validateStatusCode(response, 401);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "error");
        
        logVerification("Request without token correctly rejected");
    }

    @Test(groups = {"auth", "integration"}, description = "Test token refresh")
    public void testTokenRefresh() {
        logStep("Testing token refresh functionality");
        
        // Get initial token
        AuthenticationManager authManager = new AuthenticationManager();
        String initialToken = authManager.authenticateWithCredentials("testuser", "testpass123");
        
        // Prepare refresh request
        Map<String, String> refreshRequest = new HashMap<>();
        refreshRequest.put("token", initialToken);
        
        logAction("Sending token refresh request");
        Response response = apiClient.post(REFRESH_TOKEN_ENDPOINT, refreshRequest);
        
        // Validate refresh response
        apiClient.getResponseValidator().validateStatusCode(response, 200);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "token");
        apiClient.getResponseValidator().validateJsonFieldExists(response, "expires_in");
        
        String newToken = response.jsonPath().getString("token");
        org.testng.Assert.assertNotEquals(newToken, initialToken, "New token should be different from original");
        
        logVerification("Token refresh successful");
    }

    @Test(groups = {"auth", "integration"}, description = "Test logout functionality")
    public void testLogout() {
        logStep("Testing user logout");
        
        // Get authentication token
        AuthenticationManager authManager = new AuthenticationManager();
        String token = authManager.authenticateWithCredentials("testuser", "testpass123");
        
        logAction("Sending logout request");
        Response response = apiClient.authenticatedPost(LOGOUT_ENDPOINT, new HashMap<>(), token);
        
        // Validate logout response
        apiClient.getResponseValidator().validateStatusCode(response, 200);
        apiClient.getResponseValidator().validateJsonField(response, "success", true);
        
        // Verify token is invalidated by trying to use it
        Response profileResponse = apiClient.authenticatedGet(PROFILE_ENDPOINT, token);
        apiClient.getResponseValidator().validateStatusCode(profileResponse, 401);
        
        logVerification("Logout successful, token invalidated");
    }
    {{/if}}

    @Test(groups = {"auth", "security"}, description = "Test password security requirements")
    public void testPasswordSecurityRequirements() {
        logStep("Testing password security requirements");
        
        // Test weak password
        Map<String, String> weakPasswordCredentials = new HashMap<>();
        weakPasswordCredentials.put("username", "newuser");
        weakPasswordCredentials.put("password", "123"); // Too weak
        weakPasswordCredentials.put("email", "newuser@example.com");
        
        logAction("Attempting to create user with weak password");
        Response response = apiClient.post("/auth/register", weakPasswordCredentials);
        
        // Should reject weak password
        apiClient.getResponseValidator().validateStatusCode(response, 400);
        apiClient.getResponseValidator().validateJsonFieldExists(response, "error");
        apiClient.getResponseValidator().validateResponseContains(response, "password");
        
        logVerification("Weak password correctly rejected");
    }

    @Test(groups = {"auth", "security"}, description = "Test rate limiting on login endpoint")
    public void testLoginRateLimit() {
        logStep("Testing rate limiting on login endpoint");
        
        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", "testuser");
        credentials.put("password", "wrongpassword");
        
        logAction("Making multiple rapid login attempts");
        
        Response lastResponse = null;
        // Make multiple rapid requests to trigger rate limiting
        for (int i = 0; i < 10; i++) {
            lastResponse = apiClient.post(LOGIN_ENDPOINT, credentials);
            if (lastResponse.getStatusCode() == 429) {
                break; // Rate limit hit
            }
        }
        
        // Validate rate limiting (either 429 or consistent 401s)
        org.testng.Assert.assertTrue(
            lastResponse.getStatusCode() == 429 || lastResponse.getStatusCode() == 401,
            "Rate limiting should be in effect"
        );
        
        logVerification("Rate limiting working correctly");
    }

    @Test(groups = {"auth", "performance"}, description = "Test authentication performance")
    public void testAuthenticationPerformance() {
        logStep("Testing authentication performance");
        
        Map<String, String> credentials = new HashMap<>();
        credentials.put("username", "testuser");
        credentials.put("password", "testpass123");
        
        logAction("Measuring authentication response time");
        long startTime = System.currentTimeMillis();
        Response response = apiClient.post(LOGIN_ENDPOINT, credentials);
        long authTime = System.currentTimeMillis() - startTime;
        
        // Validate performance
        apiClient.getResponseValidator().validateStatusCode(response, 200);
        apiClient.getResponseValidator().validateResponseTime(response, 2000); // Should be under 2 seconds
        
        {{#if utilities.logger}}
        Log.info("Authentication took: " + authTime + "ms");
        {{/if}}
        
        logVerification("Authentication performance test completed");
    }
}