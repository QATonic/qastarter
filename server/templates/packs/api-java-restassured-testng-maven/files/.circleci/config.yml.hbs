version: 2.1

executors:
  maven-executor:
    docker:
      - image: cimg/openjdk:11.0
    working_directory: ~/project
    environment:
      MAVEN_OPTS: -Xmx1024m

jobs:
  test:
    executor: maven-executor
    parameters:
      environment:
        type: string
        default: "qa"
    steps:
      - checkout
      
      - restore_cache:
          keys:
            - maven-repo-v1-{{ checksum "pom.xml" }}
            - maven-repo-v1-
      
      - run:
          name: Install dependencies
          command: mvn dependency:go-offline
      
      - save_cache:
          paths:
            - ~/.m2
          key: maven-repo-v1-{{ checksum "pom.xml" }}
      
      - run:
          name: Run {{#if (eq testingPattern "bdd")}}Cucumber BDD{{else}}TestNG{{/if}} tests
          command: |
            mvn clean test {{#if (eq testingPattern "bdd")}}-Dincludes="**/runners/*TestRunner.java"{{else}}-Denvironment=<<parameters.environment>>{{/if}}
          environment:
            ENVIRONMENT: <<parameters.environment>>
      
      {{#if (eq reportingTool "allure")}}
      - run:
          name: Install Allure CLI
          command: |
            wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
            tar -zxvf allure-2.25.0.tgz -C /opt/
            sudo ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
          when: always
      
      - run:
          name: Generate Allure report
          command: |
            allure generate target/allure-results --clean -o allure-report
          when: always
      
      - store_artifacts:
          path: target/allure-results
          destination: allure-results-<<parameters.environment>>
      
      - store_artifacts:
          path: allure-report
          destination: allure-report-<<parameters.environment>>
      {{/if}}
      
      {{#if (eq reportingTool "extentreports")}}
      - store_artifacts:
          path: test-output/extent-reports
          destination: extent-reports-<<parameters.environment>>
      {{/if}}
      
      {{#if (eq reportingTool "testng-reports")}}
      - store_artifacts:
          path: target/surefire-reports
          destination: testng-reports-<<parameters.environment>>
      {{/if}}
      
      {{#if (eq reportingTool "junit-html")}}
      - store_artifacts:
          path: target/surefire-reports
          destination: junit-html-reports-<<parameters.environment>>
      {{/if}}
      
      - store_test_results:
          path: target/surefire-reports

workflows:
  test-workflow:
    jobs:
      - test:
          name: "Test QA Environment"
          environment: "qa"
      - test:
          name: "Test Dev Environment"
          environment: "dev"
