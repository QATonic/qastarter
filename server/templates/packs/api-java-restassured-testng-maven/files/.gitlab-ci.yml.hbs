# {{projectName}} - GitLab CI Pipeline
# REST API Test Automation with REST Assured, TestNG, and Maven

stages:
- build
- test
- report

variables:
MAVEN_OPTS: "-Dmaven.repo.local=$CI_PROJECT_DIR/.m2/repository -Xmx1024m"
JAVA_VERSION: "17"

cache:
key: ${CI_COMMIT_REF_SLUG}
paths:
- .m2/repository/

build:
stage: build
image: maven:3.9-eclipse-temurin-17
script:
- mvn clean compile -DskipTests
artifacts:
paths:
- target/
expire_in: 1 hour

api-tests:
stage: test
image: maven:3.9-eclipse-temurin-17
parallel:
matrix:
- ENVIRONMENT: [qa, dev]
script:
- echo "Running API tests on $ENVIRONMENT environment"
{{#if (eq testingPattern "bdd")}}
- mvn test -Dincludes="**/runners/*TestRunner.java"
{{else}}
- mvn test -Denvironment=$ENVIRONMENT
{{/if}}
artifacts:
when: always
paths:
- target/surefire-reports/
{{#if (eq reportingTool "allure")}}
- target/allure-results/
{{/if}}
{{#if (eq reportingTool "extent-reports")}}
- reports/extent-reports/
{{/if}}
reports:
junit: target/surefire-reports/TEST-*.xml
expire_in: 7 days
allow_failure: true

{{#if (eq reportingTool "allure")}}
allure-report:
stage: report
image: frankescobar/allure-docker-service:2.21.0
needs:
- job: api-tests
artifacts: true
script:
- allure generate target/allure-results --clean -o allure-report
artifacts:
paths:
- allure-report/
expire_in: 14 days
when: always
{{/if}}

{{#if (eq reportingTool "extent-reports")}}
publish-extent-report:
stage: report
needs:
- job: api-tests
artifacts: true
script:
- echo "ExtentReports available in artifacts"
artifacts:
paths:
- reports/extent-reports/
expire_in: 14 days
when: always
{{/if}}