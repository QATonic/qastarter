package {{packageName}}.steps;

import {{packageName}}.core.APIClient;
import {{packageName}}.core.RequestBuilder;
import {{packageName}}.core.ResponseValidator;
import {{packageName}}.utils.AuthenticationManager;
import {{packageName}}.utils.Log;
import io.cucumber.java.en.*;
import io.restassured.response.Response;
import static org.hamcrest.MatcherAssert.assertThat;
import static org.hamcrest.Matchers.*;

import java.util.HashMap;
import java.util.Map;

public class AuthenticationSteps {
    
    private APIClient apiClient;
    private RequestBuilder requestBuilder;
    private ResponseValidator validator;
    private AuthenticationManager authManager;
    private Response response;
    private Map<String, Object> credentials;
    private String authToken;
    private String oldToken;
    
    public AuthenticationSteps() {
        this.apiClient = APIClient.getInstance();
        this.requestBuilder = new RequestBuilder();
        this.validator = new ResponseValidator();
        this.authManager = new AuthenticationManager();
        this.credentials = new HashMap<>();
    }
    
    @Given("I have valid login credentials with username {string} and password {string}")
    public void i_have_valid_login_credentials(String username, String password) {
        credentials = new HashMap<>();
        credentials.put("email", username);
        credentials.put("password", password);
        
        Log.info("Created login credentials for: " + username);
        requestBuilder.setBody(credentials);
    }
    
    @Given("I have login credentials with username {string} and password {string}")
    public void i_have_login_credentials(String username, String password) {
        credentials = new HashMap<>();
        credentials.put("email", username);
        credentials.put("password", password);
        
        Log.info("Created login credentials for: " + username);
        requestBuilder.setBody(credentials);
    }
    
    @Given("I have incomplete login credentials")
    public void i_have_incomplete_login_credentials() {
        credentials = new HashMap<>();
        credentials.put("email", "test@example.com");
        // Missing password
        
        Log.info("Created incomplete login credentials");
        requestBuilder.setBody(credentials);
    }
    
    @Given("I have a valid authentication token")
    public void i_have_a_valid_authentication_token() {
        authToken = authManager.getValidToken();
        Log.info("Using valid authentication token");
        requestBuilder.addHeader("Authorization", "Bearer " + authToken);
    }
    
    @Given("I have an invalid authentication token")
    public void i_have_an_invalid_authentication_token() {
        authToken = "invalid-token-12345";
        Log.info("Using invalid authentication token");
        requestBuilder.addHeader("Authorization", "Bearer " + authToken);
    }
    
    @Given("I do not have an authentication token")
    public void i_do_not_have_an_authentication_token() {
        Log.info("Not setting any authentication token");
        // Don't add Authorization header
    }
    
    @Given("I have a valid refresh token")
    public void i_have_a_valid_refresh_token() {
        oldToken = authManager.getValidToken();
        Map<String, String> refreshData = new HashMap<>();
        refreshData.put("refresh_token", authManager.getRefreshToken());
        
        Log.info("Using valid refresh token");
        requestBuilder.setBody(refreshData);
    }
    
    @When("I send an authenticated GET request to {string} endpoint")
    public void i_send_an_authenticated_get_request_to_endpoint(String endpoint) {
        Log.info("Sending authenticated GET request to: " + endpoint);
        response = requestBuilder.get(endpoint);
        Log.info("Response received with status code: " + response.getStatusCode());
    }
    
    @Then("the response should contain authentication token")
    public void the_response_should_contain_authentication_token() {
        Log.info("Validating authentication token exists");
        authToken = response.jsonPath().getString("token");
        assertThat("Response should contain authentication token", 
                  authToken, 
                  notNullValue());
    }
    
    @Then("the authentication token should not be empty")
    public void the_authentication_token_should_not_be_empty() {
        Log.info("Validating authentication token is not empty");
        assertThat("Authentication token should not be empty", 
                  authToken, 
                  not(emptyOrNullString()));
    }
    
    @Then("the response should contain error message {string}")
    public void the_response_should_contain_error_message(String expectedMessage) {
        Log.info("Validating error message: " + expectedMessage);
        String actualMessage = response.jsonPath().getString("error");
        assertThat("Error message should match", 
                  actualMessage.toLowerCase(), 
                  containsString(expectedMessage.toLowerCase()));
    }
    
    @Then("the response should contain user profile information")
    public void the_response_should_contain_user_profile_information() {
        Log.info("Validating user profile information exists");
        assertThat("Response should contain user data", 
                  response.jsonPath().get("data"), 
                  notNullValue());
    }
    
    @Then("the response should contain logout confirmation")
    public void the_response_should_contain_logout_confirmation() {
        Log.info("Validating logout confirmation");
        String message = response.jsonPath().getString("message");
        assertThat("Response should contain logout confirmation", 
                  message.toLowerCase(), 
                  containsString("logout"));
    }
    
    @Then("the response should contain new authentication token")
    public void the_response_should_contain_new_authentication_token() {
        Log.info("Validating new authentication token exists");
        String newToken = response.jsonPath().getString("token");
        assertThat("Response should contain new authentication token", 
                  newToken, 
                  notNullValue());
        
        // Store the new token for subsequent steps
        authToken = newToken;
    }
    
    @Then("the new token should be different from the old token")
    public void the_new_token_should_be_different_from_the_old_token() {
        Log.info("Validating new token is different from old token");
        assertThat("New token should be different from old token", 
                  authToken, 
                  not(equalTo(oldToken)));
    }
}
