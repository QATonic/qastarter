import { ApolloClient, InMemoryCache, HttpLink, ApolloLink } from '@apollo/client/core';
import { onError } from '@apollo/client/link/error';
import fetch from 'cross-fetch';
import { getEnvironmentConfig } from '../config/environments';

const config = getEnvironmentConfig();

// Error handling link
const errorLink = onError(({ graphQLErrors, networkError }) => {
if (graphQLErrors) {
graphQLErrors.forEach(({ message, locations, path }) => {
console.error(
`[GraphQL error]: Message: ${message}, Location: ${JSON.stringify(locations)}, Path: ${path}`
);
});
}
if (networkError) {
console.error(`[Network error]: ${networkError}`);
}
});

// HTTP link with authentication
const httpLink = new HttpLink({
uri: config.graphqlEndpoint,
fetch,
headers: {
'Content-Type': 'application/json',
},
});

// Auth link for adding authentication headers
const authLink = new ApolloLink((operation, forward) => {
const token = process.env.AUTH_TOKEN;

operation.setContext(({ headers = {} }) => ({
headers: {
...headers,
authorization: token ? `Bearer ${token}` : '',
},
}));

return forward(operation);
});

// Create Apollo Client instance
export const graphqlClient = new ApolloClient({
link: ApolloLink.from([errorLink, authLink, httpLink]),
cache: new InMemoryCache(),
defaultOptions: {
watchQuery: {
fetchPolicy: 'no-cache',
errorPolicy: 'all',
},
query: {
fetchPolicy: 'no-cache',
errorPolicy: 'all',
},
mutate: {
errorPolicy: 'all',
},
},
});

// Reset client cache between tests
export const resetClient = () => {
graphqlClient.resetStore();
};

// Set authentication token
export const setAuthToken = (token: string) => {
process.env.AUTH_TOKEN = token;
};