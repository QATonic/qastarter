/**
 * gRPC Client - Client for gRPC API testing.
 * 
 * Note: Uses grpc-js for Node.js gRPC support.
 */
import * as grpc from "@grpc/grpc-js";
import * as protoLoader from "@grpc/proto-loader";
import { log } from "../utils/Logger";
import { apiConfig } from "../config/ConfigReader";

export class GrpcClient {
  private client: any;

  constructor(protoPath: string, packageName: string, serviceName: string) {
    const packageDefinition = protoLoader.loadSync(protoPath, {
      keepCase: true,
      longs: String,
      enums: String,
      defaults: true,
      oneofs: true,
    });

    const protoDescriptor = grpc.loadPackageDefinition(packageDefinition);
    const servicePackage = protoDescriptor[packageName] as any;
    
    this.client = new servicePackage[serviceName](
      apiConfig.grpcHost,
      grpc.credentials.createInsecure()
    );

    log.info(`gRPC Client initialized: ${apiConfig.grpcHost}`);
  }

  async unaryCall<TRequest, TResponse>(method: string, request: TRequest): Promise<TResponse> {
    return new Promise((resolve, reject) => {
      log.info(`gRPC Call: ${method}`);
      this.client[method](request, (error: any, response: TResponse) => {
        if (error) {
          log.error(`gRPC Error: ${error.message}`);
          reject(error);
        } else {
          log.info("gRPC Call successful");
          resolve(response);
        }
      });
    });
  }
}