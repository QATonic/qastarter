import request, { Response } from 'supertest';
import { config } from '../config/settings';
import { logger } from '../utils/logger';

/**
 * Base API client using Supertest
 * Provides reusable methods for API testing
 */
export class ApiClient {
  private baseUrl: string;
  private defaultHeaders: Record<string, string>;

  constructor(baseUrl: string = config.baseUrl) {
    this.baseUrl = baseUrl;
    this.defaultHeaders = config.headers;
  }

  /**
   * GET request
   */
  async get(endpoint: string, headers: Record<string, string> = {}): Promise<Response> {
    logger.info(`GET ${endpoint}`);
    return request(this.baseUrl)
      .get(endpoint)
      .set({ ...this.defaultHeaders, ...headers })
      .timeout(config.timeout);
  }

  /**
   * POST request
   */
  async post(endpoint: string, body: any, headers: Record<string, string> = {}): Promise<Response> {
    logger.info(`POST ${endpoint}`, { body });
    return request(this.baseUrl)
      .post(endpoint)
      .send(body)
      .set({ ...this.defaultHeaders, ...headers })
      .timeout(config.timeout);
  }

  /**
   * PUT request
   */
  async put(endpoint: string, body: any, headers: Record<string, string> = {}): Promise<Response> {
    logger.info(`PUT ${endpoint}`, { body });
    return request(this.baseUrl)
      .put(endpoint)
      .send(body)
      .set({ ...this.defaultHeaders, ...headers })
      .timeout(config.timeout);
  }

  /**
   * PATCH request
   */
  async patch(endpoint: string, body: any, headers: Record<string, string> = {}): Promise<Response> {
    logger.info(`PATCH ${endpoint}`, { body });
    return request(this.baseUrl)
      .patch(endpoint)
      .send(body)
      .set({ ...this.defaultHeaders, ...headers })
      .timeout(config.timeout);
  }

  /**
   * DELETE request
   */
  async delete(endpoint: string, headers: Record<string, string> = {}): Promise<Response> {
    logger.info(`DELETE ${endpoint}`);
    return request(this.baseUrl)
      .delete(endpoint)
      .set({ ...this.defaultHeaders, ...headers })
      .timeout(config.timeout);
  }

  /**
   * Add authentication token to headers
   */
  withAuth(token: string): this {
    this.defaultHeaders['Authorization'] = `Bearer ${token}`;
    return this;
  }
}

export const apiClient = new ApiClient();
