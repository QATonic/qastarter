pipeline {
    agent {
        label 'windows'
    }
    
    parameters {
        choice(
            name: 'ENVIRONMENT',
            choices: ['qa', 'dev', 'staging', 'prod'],
            description: 'Select test environment'
        )
        choice(
            name: 'APPLICATION',
            choices: ['calculator', 'notepad', 'custom'],
            description: 'Select application to test'
        )
    }
    
    environment {
        DOTNET_CLI_TELEMETRY_OPTOUT = '1'
        DOTNET_NOLOGO = 'true'
    }
    
    stages {
        stage('Checkout') {
            steps {
                script {
                    echo "Starting {{projectName}} Desktop Test Pipeline"
                    echo "Environment: ${params.ENVIRONMENT}"
                    echo "Application: ${params.APPLICATION}"
                }
                checkout scm
                bat 'if exist TestResults rmdir /s /q TestResults'
                bat 'if exist allure-report rmdir /s /q allure-report'
                bat 'if exist allure-results rmdir /s /q allure-results'
                bat 'if exist Screenshots rmdir /s /q Screenshots'
            }
        }
        
        stage('Setup WinAppDriver') {
            steps {
                script {
                    echo "Starting WinAppDriver"
                }
                bat '''
                    taskkill /F /IM WinAppDriver.exe 2>nul || echo WinAppDriver not running
                    start "" "C:\\Program Files (x86)\\Windows Application Driver\\WinAppDriver.exe"
                    timeout /t 5
                '''
            }
        }
        
        stage('Restore') {
            steps {
                script {
                    echo "Restoring NuGet packages"
                }
                bat 'dotnet restore'
            }
        }
        
        stage('Build') {
            steps {
                script {
                    echo "Building project"
                }
                bat 'dotnet build --configuration Release --no-restore'
            }
        }
        
        stage('Test') {
            steps {
                script {
                    echo "Running Desktop Tests"
                }
                catchError(buildResult: 'UNSTABLE', stageResult: 'FAILURE') {
                    bat """
                        dotnet test --configuration Release --no-build ^
                            --logger "trx;LogFileName=test-results.trx" ^
                            --logger "html;LogFileName=test-results.html" ^
                            --results-directory TestResults ^
                            -e ENVIRONMENT=${params.ENVIRONMENT} ^
                            -e APPLICATION=${params.APPLICATION}
                    """
                }
            }
        }
        
        {{#if (eq reportingTool "allure")}}
        stage('Install Allure CLI') {
            steps {
                script {
                    bat '''
                        mkdir allure 2>nul
                        powershell -Command "Invoke-WebRequest -Uri 'https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.zip' -OutFile 'allure.zip'"
                        powershell -Command "Expand-Archive -Path 'allure.zip' -DestinationPath 'allure' -Force"
                    '''
                }
            }
        }
        
        stage('Generate Allure Report') {
            steps {
                script {
                    bat '''
                        allure\\allure-2.25.0\\bin\\allure.bat generate allure-results --clean -o allure-report
                    '''
                }
            }
        }
        {{/if}}
    }
    
    post {
        always {
            bat 'taskkill /F /IM WinAppDriver.exe 2>nul || echo WinAppDriver stopped'
            
            mstest testResultsFile: 'TestResults/*.trx', keepLongStdio: true
            
            archiveArtifacts artifacts: 'Screenshots/**/*', 
                           fingerprint: true, 
                           allowEmptyArchive: true
            
            {{#if (eq reportingTool "allure")}}
            archiveArtifacts artifacts: 'allure-results/**/*', 
                           fingerprint: true, 
                           allowEmptyArchive: true
            
            archiveArtifacts artifacts: 'allure-report/**/*', 
                           fingerprint: true, 
                           allowEmptyArchive: true
            
            allure([
                includeProperties: false,
                jdk: '',
                properties: [],
                reportBuildPolicy: 'ALWAYS',
                results: [[path: 'allure-results']]
            ])
            {{/if}}
            
            {{#if (eq reportingTool "extent-reports")}}
            archiveArtifacts artifacts: 'TestResults/extent-reports/**/*', 
                           fingerprint: true, 
                           allowEmptyArchive: true
            
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'TestResults/extent-reports',
                reportFiles: '*.html',
                reportName: 'ExtentReports',
                reportTitles: '{{projectName}} Desktop Test Results'
            ])
            {{/if}}
            
            {{#if (eq reportingTool "nunit-reports")}}
            archiveArtifacts artifacts: 'TestResults/**/*', 
                           fingerprint: true, 
                           allowEmptyArchive: true
            
            publishHTML([
                allowMissing: true,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'TestResults',
                reportFiles: 'test-results.html',
                reportName: 'NUnit Report',
                reportTitles: '{{projectName}} NUnit Results'
            ])
            {{/if}}
            
            cleanWs()
        }
        
        success {
            script {
                echo "{{projectName}} Desktop Tests - SUCCESS"
            }
        }
        
        failure {
            script {
                echo "{{projectName}} Desktop Tests - FAILURE"
            }
        }
    }
}
