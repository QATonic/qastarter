trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'windows-latest'

variables:
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  DOTNET_VERSION: '{{toolVersions.dotnet}}'
  ENVIRONMENT: 'qa'

stages:
  - stage: Test
    displayName: 'Run Desktop Tests'
    jobs:
      - job: TestJob
        displayName: 'Execute WinAppDriver Tests'
        steps:
          - task: Cache@2
            inputs:
              key: 'nuget | "$(Agent.OS)" | **/*.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)"
                nuget
              path: $(NUGET_PACKAGES)
            displayName: 'Cache NuGet packages'
          
          - task: UseDotNet@2
            inputs:
              version: '$(DOTNET_VERSION)'
              packageType: 'sdk'
            displayName: 'Install .NET SDK'
          
          - powershell: |
              Start-Process -FilePath "C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe" -PassThru
              Start-Sleep -Seconds 5
            displayName: 'Start WinAppDriver'
          
          - script: dotnet restore
            displayName: 'Restore NuGet packages'
          
          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build project'
          
          - script: |
              dotnet test --configuration Release --no-build ^
                --logger "trx;LogFileName=test-results.trx" ^
                --logger "html;LogFileName=test-results.html" ^
                --results-directory $(Build.SourcesDirectory)\TestResults ^
                -e ENVIRONMENT=$(ENVIRONMENT)
            displayName: 'Run Desktop Tests'
            env:
              ENVIRONMENT: $(ENVIRONMENT)
          
          - powershell: |
              Stop-Process -Name "WinAppDriver" -Force -ErrorAction SilentlyContinue
            displayName: 'Stop WinAppDriver'
            condition: always()
          
          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/TestResults/*.trx'
              testRunTitle: 'Desktop Tests'
            displayName: 'Publish Test Results'
          
          {{#if (eq reportingTool "allure")}}
          - powershell: |
              Invoke-WebRequest -Uri "https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.zip" -OutFile "allure.zip"
              Expand-Archive -Path "allure.zip" -DestinationPath "allure" -Force
            displayName: 'Install Allure CLI'
            condition: always()
          
          - script: |
              allure\allure-2.25.0\bin\allure.bat generate allure-results --clean -o allure-report
            displayName: 'Generate Allure report'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-results'
              ArtifactName: 'allure-results'
              publishLocation: 'Container'
            displayName: 'Publish Allure results'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-report'
              ArtifactName: 'allure-report'
              publishLocation: 'Container'
            displayName: 'Publish Allure report'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "extent-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults/extent-reports'
              ArtifactName: 'extent-reports'
              publishLocation: 'Container'
            displayName: 'Publish ExtentReports'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "nunit-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults'
              ArtifactName: 'nunit-reports'
              publishLocation: 'Container'
            displayName: 'Publish NUnit Reports'
            condition: always()
          {{/if}}
          
          - task: PublishBuildArtifacts@1
            condition: failed()
            inputs:
              PathtoPublish: 'Screenshots'
              ArtifactName: 'screenshots'
            displayName: 'Publish Screenshots on Failure'
