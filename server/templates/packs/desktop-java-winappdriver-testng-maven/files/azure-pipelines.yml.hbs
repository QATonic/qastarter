trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'windows-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER) -Dmaven.test.failure.ignore=true'
  JAVA_HOME: '$(JAVA_HOME_11_X64)'
  ENVIRONMENT: 'qa'
  WINAPPDRIVER_URL: 'http://127.0.0.1:4723'

steps:
  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '{{toolVersions.java}}'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: 'Set up JDK {{toolVersions.java}}'

  - task: Cache@2
    inputs:
      key: 'maven | "$(Agent.OS)" | pom.xml'
      restoreKeys: |
        maven | "$(Agent.OS)"
        maven
      path: $(MAVEN_CACHE_FOLDER)
    displayName: 'Cache Maven local repo'

  - script: |
      java -version
      mvn -version
    displayName: 'Check Java and Maven versions'

  - powershell: |
      Write-Host "Starting WinAppDriver..."
      $winAppDriverPath = "C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe"
      if (Test-Path $winAppDriverPath) {
          Start-Process -FilePath $winAppDriverPath -PassThru
          Start-Sleep -Seconds 5
          Write-Host "WinAppDriver started"
      } else {
          Write-Host "WinAppDriver not found at $winAppDriverPath"
          Write-Host "Downloading WinAppDriver..."
          Invoke-WebRequest -Uri "https://github.com/Microsoft/WinAppDriver/releases/download/v1.2.1/WindowsApplicationDriver_1.2.1.msi" -OutFile "WinAppDriver.msi"
          Start-Process msiexec.exe -Wait -ArgumentList '/i WinAppDriver.msi /quiet'
          Start-Process -FilePath $winAppDriverPath -PassThru
          Start-Sleep -Seconds 5
      }
    displayName: 'Start WinAppDriver'

  - script: mvn clean compile test-compile
    displayName: 'Build project'

  - script: |
      mvn test ^
        -Denvironment=$(ENVIRONMENT) ^
        -Dwinappdriver.url=$(WINAPPDRIVER_URL) ^
        -Dscreenshot.on.failure=true
    displayName: 'Run Desktop Tests'

{{#if (eq reportingTool "allure")}}
  - script: mvn allure:report || exit 0
    displayName: 'Generate Allure Report'
    condition: always()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Results'
    condition: always()
    inputs:
      PathtoPublish: 'target/allure-results'
      ArtifactName: 'allure-results'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Report'
    condition: always()
    inputs:
      PathtoPublish: 'target/site/allure-maven-plugin'
      ArtifactName: 'allure-report'
{{/if}}

{{#if (eq reportingTool "extent-reports")}}
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Extent Reports'
    condition: always()
    inputs:
      PathtoPublish: 'reports'
      ArtifactName: 'extent-reports'
{{/if}}

{{#if (eq reportingTool "testng-reports")}}
  - task: PublishTestResults@2
    displayName: 'Publish TestNG Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'target/surefire-reports/*.xml'
      testRunTitle: 'Desktop WinAppDriver Tests'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish TestNG Reports'
    condition: always()
    inputs:
      PathtoPublish: 'target/surefire-reports'
      ArtifactName: 'testng-reports'
{{/if}}

{{#if (eq reportingTool "junit-reports")}}
  - task: PublishTestResults@2
    displayName: 'Publish JUnit Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'target/surefire-reports/*.xml'
      testRunTitle: 'Desktop WinAppDriver Tests'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish JUnit Reports'
    condition: always()
    inputs:
      PathtoPublish: 'target/surefire-reports'
      ArtifactName: 'junit-reports'
{{/if}}

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Screenshots'
    condition: failed()
    inputs:
      PathtoPublish: 'screenshots'
      ArtifactName: 'screenshots'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Logs'
    condition: always()
    inputs:
      PathtoPublish: 'logs'
      ArtifactName: 'logs'

  - powershell: |
      Write-Host "Stopping WinAppDriver..."
      Stop-Process -Name "WinAppDriver" -Force -ErrorAction SilentlyContinue
    displayName: 'Stop WinAppDriver'
    condition: always()
