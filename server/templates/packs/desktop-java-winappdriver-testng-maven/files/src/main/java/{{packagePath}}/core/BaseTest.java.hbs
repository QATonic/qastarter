package {{groupId}}.core;

import {{groupId}}.config.ConfigurationReader;
import {{groupId}}.utils.Log;
import {{groupId}}.utils.ScreenshotUtils;
import {{groupId}}.utils.ExtentManager;
import com.aventstack.extentreports.ExtentTest;
import io.appium.java_client.windows.WindowsDriver;
import org.testng.ITestResult;
import org.testng.annotations.*;

import java.lang.reflect.Method;

/**
 * Base test class providing common desktop testing functionality
 * Handles driver lifecycle, test setup/teardown, and reporting integration
 */
public class BaseTest {

    protected WindowsDriver driver;
    protected ExtentTest test;
    protected String applicationPath;

    /**
     * Suite-level setup - Initialize configurations and reporting
     */
    @BeforeSuite(alwaysRun = true)
    public void suiteSetup() {
        Log.info("=== Starting Desktop Test Suite ===");
        
        // Initialize configuration
        try {
            ConfigurationReader.initialize();
            Log.info("Configuration initialized successfully");
        } catch (Exception e) {
            Log.error("Failed to initialize configuration: " + e.getMessage());
            throw new RuntimeException("Configuration initialization failed", e);
        }

        // Initialize reporting
        try {
            ExtentManager.initializeReport();
            Log.info("Extent Reports initialized successfully");
        } catch (Exception e) {
            Log.error("Failed to initialize Extent Reports: " + e.getMessage());
        }

        Log.info("Suite setup completed successfully");
    }

    /**
     * Test-level setup - Initialize driver and test reporting
     */
    @BeforeMethod(alwaysRun = true)
    public void testSetup(Method method) {
        String testName = method.getName();
        String className = this.getClass().getSimpleName();
        
        Log.info("=== Starting Test: " + testName + " ===");

        // Create test in Extent Report
        try {
            test = ExtentManager.createTest(className + " - " + testName);
            Log.info("Extent test created: " + testName);
        } catch (Exception e) {
            Log.error("Failed to create Extent test: " + e.getMessage());
        }

        // Get application path from configuration or test annotation
        applicationPath = getApplicationPathForTest(method);
        
        // Initialize driver
        try {
            initializeDriverForTest(applicationPath);
            driver = DriverManager.getDriver();
            
            if (driver != null) {
                Log.info("Desktop driver initialized successfully for test: " + testName);
                if (test != null) {
                    test.info("Desktop driver initialized for application: " + applicationPath);
                }
            } else {
                throw new RuntimeException("Driver is null after initialization");
            }
        } catch (Exception e) {
            Log.error("Failed to initialize driver for test '" + testName + "': " + e.getMessage());
            if (test != null) {
                test.fail("Failed to initialize desktop driver: " + e.getMessage());
            }
            throw new RuntimeException("Driver initialization failed", e);
        }
    }

    /**
     * Test-level teardown - Handle test results and cleanup
     */
    @AfterMethod(alwaysRun = true)
    public void testTeardown(ITestResult result) {
        String testName = result.getMethod().getMethodName();
        
        // Handle test result for reporting
        if (test != null) {
            try {
                switch (result.getStatus()) {
                    case ITestResult.SUCCESS:
                        test.pass("Test passed successfully");
                        Log.info("Test PASSED: " + testName);
                        break;
                    case ITestResult.FAILURE:
                        test.fail("Test failed: " + result.getThrowable().getMessage());
                        Log.error("Test FAILED: " + testName + " - " + result.getThrowable().getMessage());
                        
                        // Take screenshot on failure
                        if (driver != null) {
                            try {
                                String screenshotPath = ScreenshotUtils.captureScreenshot(testName + "_FAILED");
                                if (screenshotPath != null) {
                                    test.addScreenCaptureFromPath(screenshotPath);
                                    Log.info("Failure screenshot captured: " + screenshotPath);
                                }
                            } catch (Exception e) {
                                Log.error("Failed to capture failure screenshot: " + e.getMessage());
                            }
                        }
                        break;
                    case ITestResult.SKIP:
                        test.skip("Test skipped: " + result.getThrowable().getMessage());
                        Log.warn("Test SKIPPED: " + testName);
                        break;
                }
            } catch (Exception e) {
                Log.error("Error handling test result for '" + testName + "': " + e.getMessage());
            }
        }

        // Cleanup driver
        try {
            if (DriverManager.isDriverInitialized()) {
                DriverManager.quitDriver();
                Log.info("Desktop driver quit successfully for test: " + testName);
            }
        } catch (Exception e) {
            Log.error("Error quitting driver for test '" + testName + "': " + e.getMessage());
        }

        Log.info("=== Completed Test: " + testName + " ===");
    }

    /**
     * Suite-level teardown - Flush reports and final cleanup
     */
    @AfterSuite(alwaysRun = true)
    public void suiteTeardown() {
        Log.info("=== Completing Desktop Test Suite ===");

        // Flush extent reports
        try {
            ExtentManager.flushReport();
            Log.info("Extent Reports flushed successfully");
        } catch (Exception e) {
            Log.error("Error flushing Extent Reports: " + e.getMessage());
        }

        Log.info("Suite teardown completed");
    }

    /**
     * Get application path for the current test method
     * @param method Test method
     * @return Application path for the test
     */
    protected String getApplicationPathForTest(Method method) {
        // Check for test-specific application configuration
        String testName = method.getName();
        String className = this.getClass().getSimpleName();
        
        try {
            // Try to get test-specific app path
            String testAppPath = ConfigurationReader.getProperty("test." + className + "." + testName + ".app");
            if (testAppPath != null && !testAppPath.trim().isEmpty()) {
                return testAppPath;
            }
            
            // Try to get class-specific app path
            String classAppPath = ConfigurationReader.getProperty("test." + className + ".app");
            if (classAppPath != null && !classAppPath.trim().isEmpty()) {
                return classAppPath;
            }
            
            // Fall back to default application
            String defaultApp = ConfigurationReader.getProperty("default.application", "calculator");
            return DesktopDriverFactory.getApplicationPath(defaultApp);
            
        } catch (Exception e) {
            Log.warn("Could not determine application path for test, using default: " + e.getMessage());
            return DesktopDriverFactory.getApplicationPath("calculator");
        }
    }

    /**
     * Initialize driver for the specific test
     * @param appPath Application path to initialize
     */
    protected void initializeDriverForTest(String appPath) {
        if (appPath == null || appPath.trim().isEmpty()) {
            throw new IllegalArgumentException("Application path cannot be null or empty");
        }

        if (appPath.equalsIgnoreCase("root") || appPath.equalsIgnoreCase("desktop")) {
            DriverManager.initializeRootDriver();
        } else {
            DriverManager.initializeDriver(appPath);
        }
    }

    /**
     * Get current test ExtentTest instance
     * @return Current ExtentTest instance
     */
    protected ExtentTest getCurrentTest() {
        return test;
    }

    /**
     * Get current driver instance
     * @return Current WindowsDriver instance
     */
    protected WindowsDriver getDriver() {
        return DriverManager.getDriver();
    }

    /**
     * Take screenshot and attach to test report
     * @param screenshotName Name for the screenshot
     */
    protected void captureScreenshot(String screenshotName) {
        if (driver != null && test != null) {
            try {
                String screenshotPath = ScreenshotUtils.captureScreenshot(screenshotName);
                if (screenshotPath != null) {
                    test.addScreenCaptureFromPath(screenshotPath);
                    Log.info("Screenshot captured and attached: " + screenshotName);
                }
            } catch (Exception e) {
                Log.error("Failed to capture screenshot '" + screenshotName + "': " + e.getMessage());
            }
        }
    }

    /**
     * Log info message to both logger and test report
     * @param message Message to log
     */
    protected void logInfo(String message) {
        Log.info(message);
        if (test != null) {
            test.info(message);
        }
    }

    /**
     * Log pass message to both logger and test report
     * @param message Message to log
     */
    protected void logPass(String message) {
        Log.info("PASS: " + message);
        if (test != null) {
            test.pass(message);
        }
    }

    /**
     * Log fail message to both logger and test report
     * @param message Message to log
     */
    protected void logFail(String message) {
        Log.error("FAIL: " + message);
        if (test != null) {
            test.fail(message);
        }
    }

    /**
     * Log warning message to both logger and test report
     * @param message Message to log
     */
    protected void logWarning(String message) {
        Log.warn("WARNING: " + message);
        if (test != null) {
            test.warning(message);
        }
    }
}