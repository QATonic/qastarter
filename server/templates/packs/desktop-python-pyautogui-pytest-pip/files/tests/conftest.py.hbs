import pytest
import shutil
import os
from config.settings import Settings
from utils.logger import Logger
from utils.screenshot_helper import ScreenshotHelper

def is_windows_app_available(executable):
    """Check if a Windows executable is available"""
    return shutil.which(executable) is not None

def is_macos_app_available(app_name):
    """Check if a macOS application is available"""
    app_path = f"/Applications/{app_name}.app"
    return os.path.exists(app_path)

def is_linux_app_available(executable):
    """Check if a Linux executable is available"""
    return shutil.which(executable) is not None

def check_app_availability():
    """Check if required platform apps are available"""
    if Settings.IS_WINDOWS:
        # On Windows, calc.exe and notepad.exe are always available
        return True
    elif Settings.IS_MACOS:
        # Check for Calculator and TextEdit on macOS
        return is_macos_app_available("Calculator") and is_macos_app_available("TextEdit")
    else:  # Linux
        # Check for gnome-calculator and gedit on Linux
        has_calc = is_linux_app_available("gnome-calculator") or is_linux_app_available("kcalc")
        has_editor = is_linux_app_available("gedit") or is_linux_app_available("kate")
        return has_calc and has_editor

@pytest.fixture(scope="session")
def check_calculator_available():
    """Check if calculator app is available on this platform"""
    if Settings.IS_WINDOWS:
        # Calculator is built-in on Windows
        return True
    elif Settings.IS_MACOS:
        if not is_macos_app_available("Calculator"):
            pytest.skip("Calculator app not found in /Applications")
    else:  # Linux
        if not (is_linux_app_available("gnome-calculator") or is_linux_app_available("kcalc")):
            pytest.skip("Calculator app not found. Install gnome-calculator or kcalc")
    return True

@pytest.fixture(scope="session")
def check_notepad_available():
    """Check if notepad/text editor app is available on this platform"""
    if Settings.IS_WINDOWS:
        # Notepad is built-in on Windows
        return True
    elif Settings.IS_MACOS:
        if not is_macos_app_available("TextEdit"):
            pytest.skip("TextEdit app not found in /Applications")
    else:  # Linux
        if not (is_linux_app_available("gedit") or is_linux_app_available("kate")):
            pytest.skip("Text editor not found. Install gedit or kate")
    return True

@pytest.fixture(scope="session", autouse=True)
def test_session_setup():
    Logger.info("=" * 80)
    Logger.info("Starting PyAutoGUI test session")
    Logger.info(f"Platform detected: {Settings.PLATFORM}")
    Logger.info("Note: Do not move the mouse during test execution")
    Logger.info("=" * 80)
    yield
    Logger.info("=" * 80)
    Logger.info("Test session completed")
    Logger.info("=" * 80)

@pytest.fixture(scope="function", autouse=True)
def test_setup_teardown(request):
    Logger.info(f"Starting test: {request.node.name}")
    yield
    
    if hasattr(request.node, 'rep_call') and request.node.rep_call.failed:
        Logger.error(f"Test FAILED: {request.node.name}")
        ScreenshotHelper.take_screenshot(request.node.name)
    else:
        Logger.info(f"Test PASSED: {request.node.name}")

@pytest.hookimpl(hookwrapper=True)
def pytest_runtest_makereport(item, call):
    outcome = yield
    rep = outcome.get_result()
    setattr(item, f"rep_{rep.when}", rep)
