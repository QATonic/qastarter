pipeline {
    agent {
        label 'windows'
    }
    
    environment {
        PYTHON_VERSION = '{{toolVersions.python}}'
        TEST_ENV = 'qa'
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    echo "Setting up Python ${PYTHON_VERSION}"
                    bat '''
                        python -m venv venv
                        call venv\\Scripts\\activate
                        python -m pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }
        
        stage('Start WinAppDriver') {
            steps {
                script {
                    bat '''
                        start /B "C:\\Program Files (x86)\\Windows Application Driver\\WinAppDriver.exe"
                        timeout /t 5
                    '''
                }
            }
        }
        
        stage('Run Desktop Tests') {
            steps {
                script {
                    bat '''
                        call venv\\Scripts\\activate
                        pytest -v
                    '''
                }
            }
        }
        
{{#if (eq reportingTool "allure")}}
        stage('Generate Allure Report') {
            steps {
                script {
                    bat '''
                        allure generate allure-results --clean -o allure-report
                    '''
                }
            }
        }
{{/if}}
    }
    
    post {
        always {
{{#if (eq reportingTool "allure")}}
            archiveArtifacts artifacts: 'allure-results/**', allowEmptyArchive: true
            archiveArtifacts artifacts: 'allure-report/**', allowEmptyArchive: true
            allure([
                includeProperties: false,
                jdk: '',
                properties: [],
                reportBuildPolicy: 'ALWAYS',
                results: [[path: 'allure-results']]
            ])
{{/if}}
{{#if (eq reportingTool "pytest-html")}}
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'report.html',
                reportName: 'Pytest HTML Report'
            ])
{{/if}}
{{#if (eq reportingTool "pytest-json-report")}}
            archiveArtifacts artifacts: 'reports/report.json', allowEmptyArchive: true
{{/if}}
            archiveArtifacts artifacts: 'screenshots/**', allowEmptyArchive: true
            archiveArtifacts artifacts: 'logs/**', allowEmptyArchive: true
            
            bat 'taskkill /F /IM WinAppDriver.exe || exit 0'
        }
        
        success {
            echo 'Desktop tests passed successfully!'
        }
        
        failure {
            echo 'Desktop tests failed. Check the artifacts for details.'
        }
    }
}
