trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'windows-latest'

variables:
  PYTHON_VERSION: '{{toolVersions.python}}'
  TEST_ENV: 'qa'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(PYTHON_VERSION)'
  displayName: 'Set up Python $(PYTHON_VERSION)'

- script: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
  displayName: 'Install dependencies'

- powershell: |
    Start-Process -FilePath "C:\Program Files (x86)\Windows Application Driver\WinAppDriver.exe" -PassThru
    Start-Sleep -Seconds 5
  displayName: 'Start WinAppDriver'

- script: |
    pytest -v
  displayName: 'Run desktop tests'
  env:
    TEST_ENV: $(TEST_ENV)

{{#if (eq reportingTool "allure")}}
- script: |
    choco install allure -y
  displayName: 'Install Allure CLI'
  condition: always()

- script: |
    allure generate allure-results --clean -o allure-report
  displayName: 'Generate Allure report'
  condition: always()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'allure-results'
    ArtifactName: 'allure-results'
    publishLocation: 'Container'
  displayName: 'Publish Allure results'
  condition: always()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'allure-report'
    ArtifactName: 'allure-report'
    publishLocation: 'Container'
  displayName: 'Publish Allure report'
  condition: always()
{{/if}}

{{#if (eq reportingTool "pytest-html")}}
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/report.html'
    ArtifactName: 'pytest-html-report'
    publishLocation: 'Container'
  displayName: 'Publish Pytest HTML report'
  condition: always()
{{/if}}

{{#if (eq reportingTool "pytest-json-report")}}
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/report.json'
    ArtifactName: 'pytest-json-report'
    publishLocation: 'Container'
  displayName: 'Publish Pytest JSON report'
  condition: always()
{{/if}}

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'screenshots'
    ArtifactName: 'screenshots'
    publishLocation: 'Container'
  displayName: 'Publish screenshots'
  condition: failed()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'logs'
    ArtifactName: 'logs'
    publishLocation: 'Container'
  displayName: 'Publish logs'
  condition: always()
