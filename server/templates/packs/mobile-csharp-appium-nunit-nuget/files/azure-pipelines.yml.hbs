trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  DOTNET_VERSION: '{{toolVersions.dotnet}}'
  ENVIRONMENT: 'qa'

stages:
  - stage: Test
    displayName: 'Run Mobile Tests'
    jobs:
      - job: AndroidTests
        displayName: 'Android Tests'
        steps:
          - task: Cache@2
            inputs:
              key: 'nuget | "$(Agent.OS)" | **/*.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)"
                nuget
              path: $(NUGET_PACKAGES)
            displayName: 'Cache NuGet packages'
          
          - task: UseDotNet@2
            inputs:
              version: '$(DOTNET_VERSION)'
              packageType: 'sdk'
            displayName: 'Install .NET SDK'
          
          - script: |
              npm install -g appium
              appium driver install uiautomator2
            displayName: 'Install Appium'
          
          - script: |
              nohup appium --address 127.0.0.1 --port 4723 > appium.log 2>&1 &
              sleep 10
            displayName: 'Start Appium Server'
          
          - script: dotnet restore
            displayName: 'Restore NuGet packages'
          
          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build project'
          
          - script: |
              dotnet test --configuration Release --no-build \
                --logger "trx;LogFileName=test-results.trx" \
                --logger "html;LogFileName=test-results.html" \
                --results-directory $(Build.SourcesDirectory)/TestResults \
                -e ENVIRONMENT=$(ENVIRONMENT) \
                -e PLATFORM=android
            displayName: 'Run Android Tests'
            env:
              ENVIRONMENT: $(ENVIRONMENT)
          
          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/TestResults/*.trx'
              testRunTitle: 'Mobile Tests - Android'
            displayName: 'Publish Test Results'
          
          {{#if (eq reportingTool "allure")}}
          - script: |
              wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
              tar -zxf allure-2.25.0.tgz -C /opt/
              sudo ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
            displayName: 'Install Allure CLI'
            condition: always()
          
          - script: |
              allure generate allure-results --clean -o allure-report
            displayName: 'Generate Allure report'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-results'
              ArtifactName: 'allure-results-android'
              publishLocation: 'Container'
            displayName: 'Publish Allure results'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-report'
              ArtifactName: 'allure-report-android'
              publishLocation: 'Container'
            displayName: 'Publish Allure report'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "extent-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults/extent-reports'
              ArtifactName: 'extent-reports-android'
              publishLocation: 'Container'
            displayName: 'Publish ExtentReports'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "nunit-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults'
              ArtifactName: 'nunit-reports-android'
              publishLocation: 'Container'
            displayName: 'Publish NUnit Reports'
            condition: always()
          {{/if}}
          
          - task: PublishBuildArtifacts@1
            condition: failed()
            inputs:
              PathtoPublish: 'Screenshots'
              ArtifactName: 'screenshots-android'
            displayName: 'Publish Screenshots on Failure'
          
          - task: PublishBuildArtifacts@1
            condition: always()
            inputs:
              PathtoPublish: 'appium.log'
              ArtifactName: 'appium-logs'
            displayName: 'Publish Appium Logs'
