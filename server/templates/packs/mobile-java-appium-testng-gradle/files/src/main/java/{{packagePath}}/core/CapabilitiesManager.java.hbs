package {{packageName}}.core;

import com.fasterxml.jackson.databind.JsonNode;
import com.fasterxml.jackson.databind.ObjectMapper;
import org.openqa.selenium.remote.DesiredCapabilities;
import {{packageName}}.config.ConfigurationReader;
{{#if utilities.logger}}
import {{packageName}}.utils.Log;
{{/if}}

import java.io.InputStream;
import java.util.Iterator;
import java.util.Map;

/**
 * Mobile capabilities management for Android and iOS platforms
 * Loads capabilities from JSON files and environment-specific configurations
 */
public class CapabilitiesManager {

    private static final ObjectMapper objectMapper = new ObjectMapper();

    /**
     * Get desired capabilities for the specified platform
     * 
     * @param platform The target platform (android/ios)
     * @return DesiredCapabilities for the platform
     */
    public static DesiredCapabilities getCapabilities(String platform) {
        try {
            DesiredCapabilities capabilities = new DesiredCapabilities();
            
            // Load platform-specific capabilities from JSON
            loadCapabilitiesFromJson(capabilities, platform);
            
            // Override with environment-specific properties
            overrideFromProperties(capabilities, platform);
            
            {{#if utilities.logger}}
            Log.info("Generated capabilities for " + platform + ": " + capabilities.toString());
            {{/if}}
            
            return capabilities;
            
        } catch (Exception e) {
            {{#if utilities.logger}}
            Log.error("Failed to generate capabilities for platform: " + platform, e);
            {{/if}}
            throw new RuntimeException("Failed to create capabilities for platform: " + platform, e);
        }
    }

    /**
     * Load capabilities from platform-specific JSON file
     * 
     * @param capabilities DesiredCapabilities to populate
     * @param platform The target platform
     */
    private static void loadCapabilitiesFromJson(DesiredCapabilities capabilities, String platform) {
        try {
            String capabilitiesFile = "/capabilities/" + platform.toLowerCase() + ".json";
            InputStream inputStream = CapabilitiesManager.class.getResourceAsStream(capabilitiesFile);
            
            if (inputStream == null) {
                {{#if utilities.logger}}
                Log.warn("Capabilities file not found: " + capabilitiesFile + ". Using default capabilities.");
                {{/if}}
                setDefaultCapabilities(capabilities, platform);
                return;
            }

            JsonNode jsonNode = objectMapper.readTree(inputStream);
            
            // Convert JSON to capabilities
            Iterator<Map.Entry<String, JsonNode>> fields = jsonNode.fields();
            while (fields.hasNext()) {
                Map.Entry<String, JsonNode> field = fields.next();
                String key = field.getKey();
                JsonNode value = field.getValue();
                
                if (value.isTextual()) {
                    capabilities.setCapability(key, value.asText());
                } else if (value.isBoolean()) {
                    capabilities.setCapability(key, value.asBoolean());
                } else if (value.isNumber()) {
                    capabilities.setCapability(key, value.asInt());
                }
            }
            
        } catch (Exception e) {
            {{#if utilities.logger}}
            Log.error("Error loading capabilities from JSON for platform: " + platform, e);
            {{/if}}
            setDefaultCapabilities(capabilities, platform);
        }
    }

    /**
     * Override capabilities with environment-specific properties
     * 
     * @param capabilities DesiredCapabilities to modify
     * @param platform The target platform
     */
    private static void overrideFromProperties(DesiredCapabilities capabilities, String platform) {
        String prefix = "mobile." + platform.toLowerCase() + ".";
        
        // Common mobile capabilities that can be overridden
        String[] overrideKeys = {
            "platformName", "platformVersion", "deviceName", "udid",
            "app", "appPackage", "appActivity", "bundleId",
            "automationName", "newCommandTimeout", "noReset", "fullReset"
        };
        
        for (String key : overrideKeys) {
            String propertyKey = prefix + key;
            String value = ConfigurationReader.getProperty(propertyKey);
            
            if (value != null && !value.isEmpty()) {
                // Convert string values to appropriate types
                Object capability = parseCapabilityValue(value);
                capabilities.setCapability(key, capability);
                {{#if utilities.logger}}
                Log.debug("Overriding capability " + key + " with value: " + value);
                {{/if}}
            }
        }
    }

    /**
     * Set default capabilities when JSON file is not available
     * 
     * @param capabilities DesiredCapabilities to populate
     * @param platform The target platform
     */
    private static void setDefaultCapabilities(DesiredCapabilities capabilities, String platform) {
        switch (platform.toLowerCase()) {
            case "android":
                capabilities.setCapability("platformName", "Android");
                capabilities.setCapability("automationName", "UiAutomator2");
                capabilities.setCapability("deviceName", "Android Emulator");
                capabilities.setCapability("newCommandTimeout", 300);
                capabilities.setCapability("noReset", true);
                break;
                
            case "ios":
                capabilities.setCapability("platformName", "iOS");
                capabilities.setCapability("automationName", "XCUITest");
                capabilities.setCapability("deviceName", "iPhone Simulator");
                capabilities.setCapability("newCommandTimeout", 300);
                capabilities.setCapability("noReset", true);
                break;
                
            default:
                throw new IllegalArgumentException("Unsupported platform: " + platform);
        }
        
        {{#if utilities.logger}}
        Log.info("Using default capabilities for platform: " + platform);
        {{/if}}
    }

    /**
     * Parse capability value to appropriate type
     * 
     * @param value String value to parse
     * @return Parsed value as appropriate type
     */
    private static Object parseCapabilityValue(String value) {
        // Boolean values
        if ("true".equalsIgnoreCase(value) || "false".equalsIgnoreCase(value)) {
            return Boolean.parseBoolean(value);
        }
        
        // Integer values
        try {
            return Integer.parseInt(value);
        } catch (NumberFormatException ignored) {
            // Not an integer, continue
        }
        
        // Return as string
        return value;
    }
}