trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'macos-latest'

variables:
  JAVA_HOME: '$(JAVA_HOME_17_X64)'
  GRADLE_OPTS: '-Xmx2048m'

steps:
  - task: JavaToolInstaller@0
    inputs:
      versionSpec: '{{toolVersions.java}}'
      jdkArchitectureOption: 'x64'
      jdkSourceOption: 'PreInstalled'
    displayName: 'Set up JDK {{toolVersions.java}}'

  - script: |
      chmod +x gradlew
      ./gradlew --version
    displayName: 'Setup Gradle'

  - script: |
      echo "y" | $ANDROID_HOME/cmdline-tools/latest/bin/sdkmanager --install "system-images;android-34;google_apis;x86_64"
      echo "no" | $ANDROID_HOME/cmdline-tools/latest/bin/avdmanager create avd -n test_device -k "system-images;android-34;google_apis;x86_64" --force
    displayName: 'Create Android Emulator'

  - script: |
      nohup $ANDROID_HOME/emulator/emulator -avd test_device -no-window -no-audio -no-boot-anim &
      adb wait-for-device shell 'while [[ -z $(getprop sys.boot_completed) ]]; do sleep 1; done;'
      adb shell input keyevent 82
    displayName: 'Start Emulator'

  - script: |
      ./gradlew assembleDebug assembleAndroidTest
    displayName: 'Build APKs'

  - script: |
      ./gradlew connectedAndroidTest --continue
    displayName: 'Run Espresso Tests'

{{#if (eq reportingTool "allure")}}
  - script: ./gradlew allureReport || true
    displayName: 'Generate Allure Report'
    condition: always()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Results'
    condition: always()
    inputs:
      PathtoPublish: 'app/build/allure-results'
      ArtifactName: 'allure-results'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Report'
    condition: always()
    inputs:
      PathtoPublish: 'app/build/allure-report'
      ArtifactName: 'allure-report'
{{/if}}

{{#if (eq reportingTool "junit-reports")}}
  - task: PublishTestResults@2
    displayName: 'Publish JUnit Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'app/build/outputs/androidTest-results/connected/**/TEST-*.xml'
      testRunTitle: 'Espresso Tests'
{{/if}}

{{#if (eq reportingTool "extent-reports")}}
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Extent Reports'
    condition: always()
    inputs:
      PathtoPublish: 'app/build/reports'
      ArtifactName: 'extent-reports'
{{/if}}

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Test Results'
    condition: always()
    inputs:
      PathtoPublish: 'app/build/outputs/androidTest-results'
      ArtifactName: 'test-results'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Test Reports'
    condition: always()
    inputs:
      PathtoPublish: 'app/build/reports/androidTests'
      ArtifactName: 'test-reports'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Screenshots'
    condition: failed()
    inputs:
      PathtoPublish: 'app/build/outputs/screenshots'
      ArtifactName: 'screenshots'

  - script: adb emu kill || true
    displayName: 'Stop Emulator'
    condition: always()
