trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'macos-latest'

variables:
  NODE_VERSION: '{{toolVersions.node}}'
  TEST_ENV: 'qa'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '{{toolVersions.node}}'
    displayName: 'Install Node.js {{toolVersions.node}}'

  - script: npm ci
    displayName: 'Install dependencies'

  - script: |
      npm install -g appium
      appium driver install uiautomator2
    displayName: 'Install Appium'

  - script: |
      appium &
      sleep 10
    displayName: 'Start Appium Server'

  - script: npm test
    displayName: 'Run mobile tests'
    env:
      TEST_ENV: $(TEST_ENV)

{{#if (eq reportingTool "allure")}}
  - script: npm run report:generate
    displayName: 'Generate Allure Report'
    condition: always()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Results'
    condition: always()
    inputs:
      PathtoPublish: 'allure-results'
      ArtifactName: 'allure-results'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Report'
    condition: always()
    inputs:
      PathtoPublish: 'allure-report'
      ArtifactName: 'allure-report'
{{/if}}

{{#if (eq reportingTool "jest-html-reporter")}}
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Jest HTML Report'
    condition: always()
    inputs:
      PathtoPublish: 'test-results/test-report.html'
      ArtifactName: 'jest-html-report'
{{/if}}

{{#if (eq reportingTool "mochawesome")}}
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Mochawesome Report'
    condition: always()
    inputs:
      PathtoPublish: 'mochawesome-report'
      ArtifactName: 'mochawesome-report'
{{/if}}

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Screenshots'
    condition: failed()
    inputs:
      PathtoPublish: 'screenshots'
      ArtifactName: 'screenshots'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Logs'
    condition: always()
    inputs:
      PathtoPublish: 'logs'
      ArtifactName: 'logs'
