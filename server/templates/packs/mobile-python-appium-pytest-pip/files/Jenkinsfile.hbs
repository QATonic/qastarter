pipeline {
    agent any
    
    environment {
        PYTHON_VERSION = '{{toolVersions.python}}'
        ANDROID_HOME = '/opt/android-sdk'
        TEST_ENV = 'qa'
    }
    
    stages {
        stage('Setup') {
            steps {
                script {
                    echo "Setting up Python ${PYTHON_VERSION}"
                    sh '''
                        python${PYTHON_VERSION} -m venv venv
                        . venv/bin/activate
                        python -m pip install --upgrade pip
                        pip install -r requirements.txt
                    '''
                }
            }
        }
        
        stage('Start Appium') {
            steps {
                script {
                    sh '''
                        appium &
                        sleep 10
                    '''
                }
            }
        }
        
        stage('Run Mobile Tests') {
            steps {
                script {
                    sh '''
                        . venv/bin/activate
                        pytest -v -n auto
                    '''
                }
            }
        }
        
{{#if (eq reportingTool "allure")}}
        stage('Install Allure CLI') {
            steps {
                script {
                    sh '''
                        mkdir -p ${WORKSPACE}/allure
                        wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
                        tar -zxvf allure-2.25.0.tgz -C ${WORKSPACE}/allure --strip-components=1
                        chmod +x ${WORKSPACE}/allure/bin/allure
                    '''
                }
            }
        }
        
        stage('Generate Allure Report') {
            steps {
                script {
                    sh '''
                        ${WORKSPACE}/allure/bin/allure generate allure-results --clean -o allure-report
                    '''
                }
            }
        }
{{/if}}
    }
    
    post {
        always {
{{#if (eq reportingTool "allure")}}
            archiveArtifacts artifacts: 'allure-results/**', allowEmptyArchive: true
            archiveArtifacts artifacts: 'allure-report/**', allowEmptyArchive: true
            allure([
                includeProperties: false,
                jdk: '',
                properties: [],
                reportBuildPolicy: 'ALWAYS',
                results: [[path: 'allure-results']]
            ])
{{/if}}
{{#if (eq reportingTool "pytest-html")}}
            publishHTML([
                allowMissing: false,
                alwaysLinkToLastBuild: true,
                keepAll: true,
                reportDir: 'reports',
                reportFiles: 'report.html',
                reportName: 'Pytest HTML Report'
            ])
{{/if}}
{{#if (eq reportingTool "pytest-json-report")}}
            archiveArtifacts artifacts: 'reports/report.json', allowEmptyArchive: true
{{/if}}
            archiveArtifacts artifacts: 'screenshots/**', allowEmptyArchive: true
            archiveArtifacts artifacts: 'logs/**', allowEmptyArchive: true
            
            sh 'pkill -f appium || true'
        }
        
        success {
            echo 'Mobile tests passed successfully!'
        }
        
        failure {
            echo 'Mobile tests failed. Check the artifacts for details.'
        }
    }
}
