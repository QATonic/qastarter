trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'macos-latest'

variables:
  SCHEME: '{{projectName}}UITests'
  DEVICE: 'iPhone 15 Pro'
  IOS_VERSION: '17.2'

steps:
  - script: |
      xcodebuild -version
      swift --version
      xcrun simctl list devices available
    displayName: 'Check Xcode and Swift versions'

  - script: |
      DEVICE_ID=$(xcrun simctl list devices available | grep "$(DEVICE) ($(IOS_VERSION))" | head -1 | grep -oE '[A-F0-9\-]{36}')
      if [ -z "$DEVICE_ID" ]; then
        echo "Simulator not found, using first available iPhone"
        DEVICE_ID=$(xcrun simctl list devices available | grep "iPhone" | head -1 | grep -oE '[A-F0-9\-]{36}')
      fi
      echo "##vso[task.setvariable variable=SIMULATOR_UDID]$DEVICE_ID"
      xcrun simctl boot $DEVICE_ID || true
    displayName: 'Boot iOS Simulator'

  - script: |
      xcodebuild build-for-testing \
        -scheme $(SCHEME) \
        -destination "platform=iOS Simulator,id=$(SIMULATOR_UDID)" \
        -derivedDataPath build \
        | xcpretty
    displayName: 'Build for Testing'

  - script: |
      xcodebuild test-without-building \
        -scheme $(SCHEME) \
        -destination "platform=iOS Simulator,id=$(SIMULATOR_UDID)" \
        -derivedDataPath build \
        -resultBundlePath TestResults.xcresult \
        | xcpretty --report junit --output test-results/junit-results.xml
    displayName: 'Run XCUITests'

  - task: PublishTestResults@2
    displayName: 'Publish Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'test-results/junit-results.xml'
      testRunTitle: 'XCUITests - $(DEVICE)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish XCResult Bundle'
    condition: always()
    inputs:
      PathtoPublish: 'TestResults.xcresult'
      ArtifactName: 'xcresult-bundle'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish JUnit Results'
    condition: always()
    inputs:
      PathtoPublish: 'test-results'
      ArtifactName: 'junit-results'

  - script: xcrun simctl shutdown $(SIMULATOR_UDID) || true
    displayName: 'Shutdown Simulator'
    condition: always()
