trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NUGET_PACKAGES: $(Pipeline.Workspace)/.nuget/packages
  DOTNET_VERSION: '{{toolVersions.dotnet}}'
  ENVIRONMENT: 'qa'

stages:
  - stage: Test
    displayName: 'Run Web Tests'
    jobs:
      - job: TestJob
        displayName: 'Execute Playwright Tests'
        strategy:
          matrix:
            Chromium:
              browserName: 'chromium'
            Firefox:
              browserName: 'firefox'
            Webkit:
              browserName: 'webkit'
        steps:
          - task: Cache@2
            inputs:
              key: 'nuget | "$(Agent.OS)" | **/*.csproj'
              restoreKeys: |
                nuget | "$(Agent.OS)"
                nuget
              path: $(NUGET_PACKAGES)
            displayName: 'Cache NuGet packages'
          
          - task: UseDotNet@2
            inputs:
              version: '$(DOTNET_VERSION)'
              packageType: 'sdk'
            displayName: 'Install .NET SDK'
          
          - script: dotnet restore
            displayName: 'Restore NuGet packages'
          
          - script: dotnet build --configuration Release --no-restore
            displayName: 'Build project'
          
          - script: pwsh bin/Release/net{{toolVersions.dotnet}}/playwright.ps1 install --with-deps
            displayName: 'Install Playwright Browsers'
          
          - script: |
              dotnet test --configuration Release --no-build \
                --logger "trx;LogFileName=test-results.trx" \
                --logger "html;LogFileName=test-results.html" \
                --results-directory $(Build.SourcesDirectory)/TestResults \
                -e ENVIRONMENT=$(ENVIRONMENT) \
                -e BROWSER=$(browserName)
            displayName: 'Run Playwright Tests - $(browserName)'
            env:
              ENVIRONMENT: $(ENVIRONMENT)
              BROWSER: $(browserName)
          
          - task: PublishTestResults@2
            condition: always()
            inputs:
              testResultsFormat: 'VSTest'
              testResultsFiles: '**/TestResults/*.trx'
              testRunTitle: 'Web Tests - $(browserName)'
            displayName: 'Publish Test Results'
          
          {{#if (eq reportingTool "allure")}}
          - script: |
              wget -q https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
              tar -zxf allure-2.25.0.tgz -C /opt/
              sudo ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
            displayName: 'Install Allure CLI'
            condition: always()
          
          - script: |
              allure generate allure-results --clean -o allure-report
            displayName: 'Generate Allure report'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-results'
              ArtifactName: 'allure-results-$(browserName)'
              publishLocation: 'Container'
            displayName: 'Publish Allure results'
            condition: always()
          
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'allure-report'
              ArtifactName: 'allure-report-$(browserName)'
              publishLocation: 'Container'
            displayName: 'Publish Allure report'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "extent-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults/extent-reports'
              ArtifactName: 'extent-reports-$(browserName)'
              publishLocation: 'Container'
            displayName: 'Publish ExtentReports'
            condition: always()
          {{/if}}
          
          {{#if (eq reportingTool "nunit-reports")}}
          - task: PublishBuildArtifacts@1
            inputs:
              PathtoPublish: 'TestResults'
              ArtifactName: 'nunit-reports-$(browserName)'
              publishLocation: 'Container'
            displayName: 'Publish NUnit Reports'
            condition: always()
          {{/if}}
          
          - task: PublishBuildArtifacts@1
            condition: failed()
            inputs:
              PathtoPublish: 'Screenshots'
              ArtifactName: 'screenshots-$(browserName)'
            displayName: 'Publish Screenshots on Failure'
