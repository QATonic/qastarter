package {{groupId}}.extensions;

import {{groupId}}.core.PlaywrightManager;
import com.microsoft.playwright.Page;
import org.junit.jupiter.api.extension.ExtensionContext;
import org.junit.jupiter.api.extension.TestWatcher;

import java.io.IOException;
import java.nio.file.Files;
import java.nio.file.Path;
import java.nio.file.Paths;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;
import java.util.Optional;

/**
* JUnit 5 Extension for capturing screenshots on test failure
* Implements TestWatcher to hook into test lifecycle
*/
public class ScreenshotExtension implements TestWatcher {

private static final String SCREENSHOTS_DIR = "screenshots";

@Override
public void testFailed(ExtensionContext context, Throwable cause) {
String testName = context.getDisplayName();
Page page = PlaywrightManager.getPage();

if (page != null) {
String screenshotPath = captureScreenshot(page, testName);
System.out.println("Screenshot saved: " + screenshotPath);
}
}

private String captureScreenshot(Page page, String testName) {
try {
Path screenshotsDir = Paths.get(SCREENSHOTS_DIR);
if (!Files.exists(screenshotsDir)) {
Files.createDirectories(screenshotsDir);
}

String timestamp = LocalDateTime.now().format(DateTimeFormatter.ofPattern("yyyyMMdd_HHmmss"));
String fileName = testName.replaceAll("[^a-zA-Z0-9]", "_") + "_" + timestamp + ".png";
Path screenshotPath = screenshotsDir.resolve(fileName);

page.screenshot(new Page.ScreenshotOptions().setPath(screenshotPath));
return screenshotPath.toString();
} catch (IOException e) {
System.err.println("Failed to save screenshot: " + e.getMessage());
return null;
}
}

@Override
public void testSuccessful(ExtensionContext context) {
// Optional: log successful test
}

@Override
public void testAborted(ExtensionContext context, Throwable cause) {
// Handle aborted tests
}

@Override
public void testDisabled(ExtensionContext context, Optional<String> reason) {
    // Handle disabled tests
    }
    }