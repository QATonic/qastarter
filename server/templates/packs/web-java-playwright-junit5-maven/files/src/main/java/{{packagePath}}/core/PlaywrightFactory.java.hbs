package {{javaPackage}}.core;

import {{javaPackage}}.config.ConfigurationReader;
import {{javaPackage}}.utils.Log;
import com.microsoft.playwright.*;

import java.nio.file.Paths;
import java.util.Arrays;

/**
 * Factory class for creating and configuring Playwright, Browser, and BrowserContext instances.
 * Provides centralized browser configuration based on properties.
 */
public class PlaywrightFactory {
    
    /**
     * Create Playwright instance
     * @return Playwright instance
     */
    public static Playwright createPlaywright() {
        try {
            Playwright playwright = Playwright.create();
            Log.info("âœ… Playwright instance created successfully");
            return playwright;
        } catch (Exception e) {
            Log.error("âŒ Failed to create Playwright instance", e);
            throw new RuntimeException("Failed to create Playwright instance", e);
        }
    }
    
    /**
     * Create Browser instance based on configuration
     * @param playwright Playwright instance
     * @return Browser instance
     */
    public static Browser createBrowser(Playwright playwright) {
        String browserName = getBrowserName();
        BrowserType.LaunchOptions launchOptions = getLaunchOptions();
        
        try {
            Browser browser;
            
            switch (browserName.toLowerCase()) {
                case "firefox":
                    Log.info("ðŸ¦Š Launching Firefox browser...");
                    browser = playwright.firefox().launch(launchOptions);
                    break;
                    
                case "webkit":
                case "safari":
                    Log.info("ðŸ§­ Launching WebKit browser...");
                    browser = playwright.webkit().launch(launchOptions);
                    break;
                    
                case "chromium":
                case "chrome":
                case "edge":
                default:
                    Log.info("ðŸŒ Launching Chromium browser...");
                    browser = playwright.chromium().launch(launchOptions);
                    break;
            }
            
            Log.info("âœ… Browser launched successfully: " + browserName);
            return browser;
            
        } catch (Exception e) {
            Log.error("âŒ Failed to launch browser: " + browserName, e);
            throw new RuntimeException("Failed to launch browser: " + browserName, e);
        }
    }
    
    /**
     * Create BrowserContext with configuration
     * @param browser Browser instance
     * @return BrowserContext instance
     */
    public static BrowserContext createContext(Browser browser) {
        Browser.NewContextOptions contextOptions = getContextOptions();
        
        try {
            BrowserContext context = browser.newContext(contextOptions);
            Log.info("âœ… Browser context created successfully");
            
            // Set default timeouts
            int defaultTimeout = ConfigurationReader.getIntProperty("default.timeout", 30000);
            context.setDefaultTimeout(defaultTimeout);
            
            int navigationTimeout = ConfigurationReader.getIntProperty("navigation.timeout", 60000);
            context.setDefaultNavigationTimeout(navigationTimeout);
            
            return context;
            
        } catch (Exception e) {
            Log.error("âŒ Failed to create browser context", e);
            throw new RuntimeException("Failed to create browser context", e);
        }
    }
    
    /**
     * Create new Page in the context
     * @param context BrowserContext instance
     * @return Page instance
     */
    public static Page createPage(BrowserContext context) {
        try {
            Page page = context.newPage();
            Log.info("âœ… New page created successfully");
            return page;
        } catch (Exception e) {
            Log.error("âŒ Failed to create page", e);
            throw new RuntimeException("Failed to create page", e);
        }
    }
    
    /**
     * Get browser name from configuration or system property
     * @return Browser name
     */
    private static String getBrowserName() {
        String browser = System.getProperty("browser", ConfigurationReader.getBrowser());
        return browser != null ? browser : "chromium";
    }
    
    /**
     * Get launch options for browser
     * @return BrowserType.LaunchOptions
     */
    private static BrowserType.LaunchOptions getLaunchOptions() {
        BrowserType.LaunchOptions options = new BrowserType.LaunchOptions();
        
        // Headless mode
        boolean headless = Boolean.parseBoolean(
            System.getProperty("headless", 
            String.valueOf(ConfigurationReader.isHeadless()))
        );
        options.setHeadless(headless);
        Log.debug("Headless mode: " + headless);
        
        // Slow motion (for debugging)
        int slowMo = ConfigurationReader.getIntProperty("slow.motion", 0);
        if (slowMo > 0) {
            options.setSlowMo(slowMo);
            Log.debug("Slow motion: " + slowMo + "ms");
        }
        
        // Browser arguments
        String browserArgs = ConfigurationReader.getProperty("browser.args");
        if (browserArgs != null && !browserArgs.trim().isEmpty()) {
            options.setArgs(Arrays.asList(browserArgs.split(",")));
            Log.debug("Browser args: " + browserArgs);
        }
        
        // Downloads path
        String downloadsPath = ConfigurationReader.getProperty("downloads.path");
        if (downloadsPath != null && !downloadsPath.trim().isEmpty()) {
            options.setDownloadsPath(Paths.get(downloadsPath));
            Log.debug("Downloads path: " + downloadsPath);
        }
        
        return options;
    }
    
    /**
     * Get context options
     * @return Browser.NewContextOptions
     */
    private static Browser.NewContextOptions getContextOptions() {
        Browser.NewContextOptions options = new Browser.NewContextOptions();
        
        // Viewport size
        int viewportWidth = ConfigurationReader.getIntProperty("viewport.width", 1920);
        int viewportHeight = ConfigurationReader.getIntProperty("viewport.height", 1080);
        options.setViewportSize(viewportWidth, viewportHeight);
        Log.debug("Viewport: " + viewportWidth + "x" + viewportHeight);
        
        // User agent
        String userAgent = ConfigurationReader.getProperty("user.agent");
        if (userAgent != null && !userAgent.trim().isEmpty()) {
            options.setUserAgent(userAgent);
            Log.debug("User agent: " + userAgent);
        }
        
        // Locale
        String locale = ConfigurationReader.getProperty("locale", "en-US");
        options.setLocale(locale);
        
        // Timezone
        String timezone = ConfigurationReader.getProperty("timezone");
        if (timezone != null && !timezone.trim().isEmpty()) {
            options.setTimezoneId(timezone);
        }
        
        // Geolocation
        String latitude = ConfigurationReader.getProperty("geolocation.latitude");
        String longitude = ConfigurationReader.getProperty("geolocation.longitude");
        if (latitude != null && longitude != null) {
            options.setGeolocation(
                Double.parseDouble(latitude), 
                Double.parseDouble(longitude)
            );
            options.setPermissions(Arrays.asList("geolocation"));
        }
        
        // Record video (if enabled)
        boolean recordVideo = ConfigurationReader.getBooleanProperty("record.video", false);
        if (recordVideo) {
            String videoPath = ConfigurationReader.getProperty("video.path", "reports/videos/");
            options.setRecordVideoDir(Paths.get(videoPath));
            Log.debug("Video recording enabled: " + videoPath);
        }
        
        // Screenshots
        options.setScreenshotOnFailure(true);
        
        return options;
    }
}
