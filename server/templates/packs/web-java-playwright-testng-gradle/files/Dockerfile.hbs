FROM eclipse-temurin:17-jdk-alpine

# Install browsers for headless testing
RUN apk add --no-cache \
    chromium \
    chromium-chromedriver \
    firefox \
    font-noto \
    font-noto-cjk

# Set environment variables
ENV CHROME_BIN=/usr/bin/chromium-browser \
    CHROME_DRIVER=/usr/bin/chromedriver \
    JAVA_OPTS="-Xmx512m"

WORKDIR /app

# Copy project files
COPY pom.xml ./
{{#if (eq buildTool "maven")}}
COPY mvnw ./
COPY .mvn .mvn
RUN chmod +x mvnw && ./mvnw dependency:resolve
{{else}}
COPY gradlew ./
COPY gradle gradle
RUN chmod +x gradlew && ./gradlew dependencies
{{/if}}

COPY src ./src

# Run tests
{{#if (eq buildTool "maven")}}
CMD ["./mvnw", "clean", "test", "-Dheadless=true"]
{{else}}
CMD ["./gradlew", "clean", "test", "-Dheadless=true"]
{{/if}}