trigger:
  branches:
    include:
      - main
      - master
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  MAVEN_CACHE_FOLDER: $(Pipeline.Workspace)/.m2/repository
  MAVEN_OPTS: '-Dmaven.repo.local=$(MAVEN_CACHE_FOLDER)'
  BROWSER: 'chromium'
  HEADLESS: 'true'

stages:
  - stage: Build
    displayName: 'Build and Install'
    jobs:
      - job: Build
        steps:
          - task: JavaToolInstaller@0
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
            displayName: 'Setup Java 17'
          
          - task: Cache@2
            inputs:
              key: 'maven | "$(Agent.OS)" | pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
                maven
              path: $(MAVEN_CACHE_FOLDER)
            displayName: 'Cache Maven packages'
          
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'clean install -DskipTests'
              options: '$(MAVEN_OPTS)'
            displayName: 'Maven Install'
          
          - script: |
              mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install --with-deps"
            displayName: 'Install Playwright Browsers'

  - stage: Test
    displayName: 'Run Tests'
    dependsOn: Build
    jobs:
      - job: TestChromium
        displayName: 'Chromium Tests'
        steps:
          - task: JavaToolInstaller@0
            inputs:
              versionSpec: '17'
              jdkArchitectureOption: 'x64'
              jdkSourceOption: 'PreInstalled'
          
          - task: Cache@2
            inputs:
              key: 'maven | "$(Agent.OS)" | pom.xml'
              restoreKeys: |
                maven | "$(Agent.OS)"
              path: $(MAVEN_CACHE_FOLDER)
          
          - script: |
              mvn exec:java -e -D exec.mainClass=com.microsoft.playwright.CLI -D exec.args="install chromium"
            displayName: 'Install Chromium'
          
          - task: Maven@3
            inputs:
              mavenPomFile: 'pom.xml'
              goals: 'test'
              options: '-Dbrowser=chromium -Dheadless=$(HEADLESS)'
            displayName: 'Run Chromium Tests'
          
          - task: PublishTestResults@2
            inputs:
              testResultsFormat: 'JUnit'
              testResultsFiles: '**/surefire-reports/*.xml'
              failTaskOnFailedTests: true
            displayName: 'Publish Test Results'
            condition: always()
          
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'screenshots'
              artifact: 'screenshots-chromium'
            displayName: 'Publish Screenshots'
            condition: always()

  - stage: Report
    displayName: 'Generate Reports'
    dependsOn: Test
    condition: always()
    jobs:
      - job: GenerateReport
        steps:
          - task: PublishPipelineArtifact@1
            inputs:
              targetPath: 'target/surefire-reports'
              artifact: 'test-reports'
            displayName: 'Publish Test Reports'
