package {{javaPackage}}.listeners;

import {{javaPackage}}.core.DriverManager;
import {{javaPackage}}.utils.ExtentManager;
import {{javaPackage}}.utils.Log;
import {{javaPackage}}.utils.ScreenshotUtils;
import com.aventstack.extentreports.ExtentTest;
import com.aventstack.extentreports.Status;
import org.testng.*;

/**
 * TestNG listener for ExtentReports integration and screenshot capture.
 * Handles test lifecycle events and reporting.
 */
public class TestListener implements ITestListener, ISuiteListener, IConfigurationListener {
    
    @Override
    public void onStart(ISuite suite) {
        Log.startSection("TEST SUITE: " + suite.getName());
        Log.info("Suite started: " + suite.getName());
        
        // Initialize ExtentReports
        ExtentManager.createInstance();
    }
    
    @Override
    public void onFinish(ISuite suite) {
        Log.info("Suite finished: " + suite.getName());
        Log.endSection();
        
        // Flush ExtentReports
        ExtentManager.flush();
        
        // Clean up old screenshots (keep for 7 days)
        ScreenshotUtils.cleanupOldScreenshots(7);
    }
    
    @Override
    public void onTestStart(ITestResult result) {
        String testName = getTestName(result);
        String testDescription = getTestDescription(result);
        
        Log.testStart(testName);
        
        // Create ExtentTest
        ExtentTest extentTest = ExtentManager.createTest(testName, testDescription);
        
        // Add test information
        ExtentManager.setTestCategory(getTestGroups(result));
        ExtentManager.setTestAuthor("QA Team");
        ExtentManager.setTestDevice(getCurrentBrowser());
        
        // Log test start
        ExtentManager.logInfo("Test started: " + testName);
        
        // Log test parameters if any
        logTestParameters(result);
    }
    
    @Override
    public void onTestSuccess(ITestResult result) {
        String testName = getTestName(result);
        long duration = result.getEndMillis() - result.getStartMillis();
        
        Log.testEnd(testName, "PASSED");
        
        // Log to ExtentReports
        ExtentManager.logPass("✅ Test passed successfully");
        ExtentManager.logInfo("Test duration: " + duration + "ms");
        
        // Remove test from ThreadLocal
        ExtentManager.removeTest();
    }
    
    @Override
    public void onTestFailure(ITestResult result) {
        String testName = getTestName(result);
        Throwable throwable = result.getThrowable();
        
        Log.testEnd(testName, "FAILED");
        Log.error("Test failed: " + testName, throwable);
        
        // Capture screenshot on failure
        String screenshotPath = ScreenshotUtils.captureFailureScreenshot(testName);
        
        // Log to ExtentReports
        ExtentManager.logFail("❌ Test failed: " + (throwable != null ? throwable.getMessage() : "Unknown error"));
        ExtentManager.logException(throwable);
        
        // Add screenshot to report if captured
        if (screenshotPath != null) {
            ExtentManager.addScreenshot(screenshotPath, "Failure Screenshot");
        }
        
        // Remove test from ThreadLocal
        ExtentManager.removeTest();
    }
    
    @Override
    public void onTestSkipped(ITestResult result) {
        String testName = getTestName(result);
        Throwable throwable = result.getThrowable();
        
        Log.testEnd(testName, "SKIPPED");
        
        // Create ExtentTest for skipped test
        String testDescription = getTestDescription(result);
        ExtentTest extentTest = ExtentManager.createTest(testName, testDescription);
        ExtentManager.setTestCategory(getTestGroups(result));
        
        // Log to ExtentReports
        String skipReason = throwable != null ? throwable.getMessage() : "Test was skipped";
        ExtentManager.logSkip("⏭️ Test skipped: " + skipReason);
        
        if (throwable != null) {
            ExtentManager.logException(throwable);
        }
        
        // Remove test from ThreadLocal
        ExtentManager.removeTest();
    }
    
    @Override
    public void onTestFailedButWithinSuccessPercentage(ITestResult result) {
        String testName = getTestName(result);
        Log.warn("Test failed but within success percentage: " + testName);
        
        ExtentManager.logWarning("⚠️ Test failed but within success percentage");
    }
    
    /**
     * Get formatted test name
     * @param result Test result
     * @return Formatted test name
     */
    private String getTestName(ITestResult result) {
        String className = result.getTestClass().getName();
        String methodName = result.getMethod().getMethodName();
        
        // Extract simple class name
        String simpleClassName = className.substring(className.lastIndexOf('.') + 1);
        
        return simpleClassName + "." + methodName;
    }
    
    /**
     * Get test description from TestNG annotations
     * @param result Test result
     * @return Test description
     */
    private String getTestDescription(ITestResult result) {
        String description = result.getMethod().getDescription();
        return description != null ? description : "No description provided";
    }
    
    /**
     * Get test groups as string array
     * @param result Test result
     * @return Test groups
     */
    private String[] getTestGroups(ITestResult result) {
        return result.getMethod().getGroups();
    }
    
    /**
     * Get current browser from system property
     * @return Browser name
     */
    private String getCurrentBrowser() {
        String browser = System.getProperty("browser", "chrome");
        boolean headless = Boolean.parseBoolean(System.getProperty("headless", "false"));
        return browser + (headless ? " (headless)" : "");
    }
    
    /**
     * Log test parameters if present
     * @param result Test result
     */
    private void logTestParameters(ITestResult result) {
        Object[] parameters = result.getParameters();
        if (parameters != null && parameters.length > 0) {
            StringBuilder paramLog = new StringBuilder("Test parameters: ");
            for (int i = 0; i < parameters.length; i++) {
                if (i > 0) paramLog.append(", ");
                paramLog.append("param").append(i + 1).append("=").append(parameters[i]);
            }
            
            ExtentManager.logInfo(paramLog.toString());
            Log.info(paramLog.toString());
        }
    }
    
    /**
     * Handle configuration failures (BeforeMethod, AfterMethod, etc.)
     * @param result Test result
     */
    @Override
    public void onConfigurationFailure(ITestResult result) {
        String configName = result.getMethod().getMethodName();
        Throwable throwable = result.getThrowable();
        
        Log.error("Configuration method failed: " + configName, throwable);
        
        // Capture screenshot for configuration failure if driver is available
        if (DriverManager.isDriverInitialized()) {
            String screenshotPath = ScreenshotUtils.captureScreenshot("CONFIG_FAILURE_" + configName);
            if (screenshotPath != null) {
                Log.info("Configuration failure screenshot captured: " + screenshotPath);
            }
        }
    }
    
    /**
     * Handle configuration success
     * @param result Test result
     */
    @Override
    public void onConfigurationSuccess(ITestResult result) {
        String configName = result.getMethod().getMethodName();
        Log.debug("Configuration method passed: " + configName);
    }
    
    /**
     * Handle configuration skip
     * @param result Test result
     */
    @Override
    public void onConfigurationSkip(ITestResult result) {
        String configName = result.getMethod().getMethodName();
        Log.warn("Configuration method skipped: " + configName);
    }
}