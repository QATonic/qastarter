package {{javaPackage}}.listeners;

import {{javaPackage}}.core.DriverManager;
import {{javaPackage}}.utils.Log;
import {{javaPackage}}.utils.ScreenshotUtils;
{{#if (eq reportingTool "extent-reports")}}
import {{javaPackage}}.utils.ExtentManager;
import com.aventstack.extentreports.ExtentTest;
import com.aventstack.extentreports.MediaEntityBuilder;
import com.aventstack.extentreports.Status;
{{/if}}
{{#if (eq reportingTool "allure")}}
import io.qameta.allure.Allure;
import java.io.ByteArrayInputStream;
{{/if}}
import org.junit.jupiter.api.extension.AfterTestExecutionCallback;
import org.junit.jupiter.api.extension.BeforeTestExecutionCallback;
import org.junit.jupiter.api.extension.ExtensionContext;

/**
 * JUnit5 Test Watcher - Handles test lifecycle events.
 * 
 * Features:
 *   - Logs test start/end with timestamps
 *   - Captures and embeds screenshots on failure
 *   - Integrates with reporting tools
 */
public class TestWatcher implements BeforeTestExecutionCallback, AfterTestExecutionCallback {

    private long startTime;

    @Override
    public void beforeTestExecution(ExtensionContext context) {
        startTime = System.currentTimeMillis();
        String testName = context.getDisplayName();
        Log.testStart(testName);

{{#if (eq reportingTool "extent-reports")}}
        try {
            ExtentTest test = ExtentManager.createTest(testName, "");
            test.log(Status.INFO, "Test execution started");
        } catch (Exception e) {
            Log.error("Failed to create ExtentTest: " + e.getMessage());
        }
{{/if}}
    }

    @Override
    public void afterTestExecution(ExtensionContext context) {
        long duration = System.currentTimeMillis() - startTime;
        String testName = context.getDisplayName();
        boolean passed = context.getExecutionException().isEmpty();

        if (passed) {
            Log.info("Test PASSED in " + duration + "ms");
            Log.testEnd(testName, true);

{{#if (eq reportingTool "extent-reports")}}
            try {
                ExtentTest test = ExtentManager.getTest();
                if (test != null) {
                    test.log(Status.PASS, "Test passed successfully");
                    test.log(Status.INFO, "Duration: " + duration + "ms");
                }
            } catch (Exception e) {
                Log.error("Failed to log success: " + e.getMessage());
            }
{{/if}}
        } else {
            Log.error("Test FAILED: " + testName);
            Log.error("Duration: " + duration + "ms");

            context.getExecutionException().ifPresent(throwable -> {
                Log.error("Failure reason: " + throwable.getMessage());
            });

{{#if (eq reportingTool "extent-reports")}}
            try {
                ExtentTest test = ExtentManager.getTest();
                if (test != null) {
                    test.log(Status.FAIL, "Test failed after " + duration + "ms");
                    context.getExecutionException().ifPresent(test::fail);
                }

                if (DriverManager.isDriverInitialized()) {
                    String screenshotPath = ScreenshotUtils.capture("FAILED_" + testName);
                    if (screenshotPath != null && test != null) {
                        test.fail("Screenshot:",
                            MediaEntityBuilder.createScreenCaptureFromPath(screenshotPath).build());
                    }
                }
            } catch (Exception e) {
                Log.error("Failed to attach screenshot: " + e.getMessage());
            }
{{/if}}

{{#if (eq reportingTool "allure")}}
            try {
                if (DriverManager.isDriverInitialized()) {
                    byte[] screenshot = ScreenshotUtils.captureAsBytes();
                    if (screenshot != null) {
                        Allure.addAttachment("Screenshot on Failure",
                            new ByteArrayInputStream(screenshot));
                    }
                    ScreenshotUtils.capture("FAILED_" + testName);
                }
            } catch (Exception e) {
                Log.error("Failed to attach screenshot: " + e.getMessage());
            }
{{/if}}

{{#unless reportingTool}}
            if (DriverManager.isDriverInitialized()) {
                ScreenshotUtils.capture("FAILED_" + testName);
            }
{{/unless}}

            Log.testEnd(testName, false);
        }
    }
}