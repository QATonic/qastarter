image: eclipse-temurin:17-jdk

stages:
  - test
  - report

variables:
  HEADLESS: "true"

{{#if (eq framework "playwright")}}
before_script:
  - apt-get update && apt-get install -y libglib2.0-0 libnss3 libx11-6 libxcb1 libxcomposite1 libxcursor1 libxdamage1 libxext6 libxfixes3 libxi6 libxrandr2 libxrender1 libxss1 libxtst6
{{#if (eq buildTool "maven")}}
  - mvn exec:java -e -Dexec.mainClass=com.microsoft.playwright.CLI -Dexec.args="install --with-deps"
{{else}}
  - ./gradlew playwright install
{{/if}}
{{/if}}

test:
  stage: test
  script:
{{#if (eq buildTool "maven")}}
    - mvn clean test -Dheadless=$HEADLESS
{{else}}
    - ./gradlew clean test -Dheadless=$HEADLESS
{{/if}}
  artifacts:
    when: always
    paths:
{{#if (eq buildTool "maven")}}
      - target/surefire-reports/
{{else}}
      - build/reports/
{{/if}}
      - screenshots/
      - reports/
    expire_in: 7 days
{{#if (eq reportingTool "allure")}}

allure-report:
  stage: report
  script:
{{#if (eq buildTool "maven")}}
    - mvn allure:report
{{else}}
    - ./gradlew allureReport
{{/if}}
  artifacts:
    paths:
{{#if (eq buildTool "maven")}}
      - target/site/allure-maven-plugin/
{{else}}
      - build/allure-report/
{{/if}}
    expire_in: 7 days
{{/if}}