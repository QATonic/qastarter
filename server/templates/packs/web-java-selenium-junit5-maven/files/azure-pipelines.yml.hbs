trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

strategy:
  matrix:
    Chrome:
      browserName: 'chrome'
    Firefox:
      browserName: 'firefox'

steps:
- task: JavaToolInstaller@0
  inputs:
    versionSpec: '{{toolVersions.java}}'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'

- task: Maven@3
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'clean test'
    options: '-Dbrowser=$(browserName)'
    publishJUnitResults: true
    testResultsFiles: '**/surefire-reports/TEST-*.xml'
    testRunTitle: 'Selenium Tests - $(browserName)'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '{{toolVersions.java}}'
    mavenVersionOption: 'Default'
    mavenOptions: '-Xmx3072m'
    mavenAuthenticateFeed: false
    effectivePomSkip: false
    sonarQubeRunAnalysis: false
  env:
    ENVIRONMENT: qa
{{#if (eq reportingTool "allure")}}

- task: Maven@3
  condition: always()
  inputs:
    mavenPomFile: 'pom.xml'
    goals: 'allure:report'
    javaHomeOption: 'JDKVersion'
    jdkVersionOption: '{{toolVersions.java}}'
    mavenVersionOption: 'Default'

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    pathToPublish: 'target/allure-results'
    artifactName: 'allure-results-$(browserName)'

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    pathToPublish: 'target/site/allure-maven-plugin'
    artifactName: 'allure-report-$(browserName)'
{{/if}}
{{#if (eq reportingTool "extent-reports")}}

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    pathToPublish: 'reports/extent-report.html'
    artifactName: 'extent-report-$(browserName)'
{{/if}}
{{#if (eq reportingTool "junit-reports")}}

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    pathToPublish: 'target/surefire-reports'
    artifactName: 'junit-reports-$(browserName)'
{{/if}}

- task: PublishBuildArtifacts@1
  condition: failed()
  inputs:
    pathToPublish: 'reports/screenshots'
    artifactName: 'screenshots-$(browserName)'

- task: PublishBuildArtifacts@1
  condition: always()
  inputs:
    pathToPublish: 'logs'
    artifactName: 'logs-$(browserName)'
