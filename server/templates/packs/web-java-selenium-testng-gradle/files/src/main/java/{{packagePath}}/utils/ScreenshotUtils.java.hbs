package {{javaPackage}}.utils;

import {{javaPackage}}.core.DriverManager;
import org.openqa.selenium.OutputType;
import org.openqa.selenium.TakesScreenshot;
import org.openqa.selenium.WebDriver;

import java.io.File;
import java.io.IOException;
import java.time.LocalDateTime;
import java.time.format.DateTimeFormatter;

/**
 * Screenshot capture utility for test reporting and debugging.
 * Provides methods to capture and save screenshots at various points during test execution.
 */
public class ScreenshotUtils {
    private static final String SCREENSHOT_DIR = System.getProperty("user.dir") + "/reports/screenshots/";
    private static final DateTimeFormatter TIMESTAMP_FORMAT = DateTimeFormatter.ofPattern("yyyy-MM-dd_HH-mm-ss-SSS");
    
    static {
        // Create screenshots directory if it doesn't exist
        createScreenshotDirectory();
    }
    
    /**
     * Create screenshots directory
     */
    private static void createScreenshotDirectory() {
        File dir = new File(SCREENSHOT_DIR);
        if (!dir.exists()) {
            if (dir.mkdirs()) {
                Log.debug("Created screenshots directory: " + SCREENSHOT_DIR);
            } else {
                Log.error("Failed to create screenshots directory: " + SCREENSHOT_DIR);
            }
        }
    }
    
    /**
     * Capture screenshot and save with timestamp
     * @return Screenshot file path
     */
    public static String captureScreenshot() {
        return captureScreenshot("screenshot_" + getCurrentTimestamp());
    }
    
    /**
     * Capture screenshot with custom filename
     * @param fileName Custom filename (without extension)
     * @return Screenshot file path
     */
    public static String captureScreenshot(String fileName) {
        try {
            WebDriver driver = DriverManager.getDriver();
            if (driver == null) {
                Log.error("WebDriver is null, cannot capture screenshot");
                return null;
            }
            
            TakesScreenshot takesScreenshot = (TakesScreenshot) driver;
            File sourceFile = takesScreenshot.getScreenshotAs(OutputType.FILE);
            
            String filePath = SCREENSHOT_DIR + fileName + ".png";
            File destFile = new File(filePath);
            
            java.nio.file.Files.copy(sourceFile.toPath(), destFile.toPath(), 
                                   java.nio.file.StandardCopyOption.REPLACE_EXISTING);
            
            Log.debug("Screenshot captured: " + filePath);
            return filePath;
            
        } catch (IOException e) {
            Log.error("Failed to capture screenshot: " + fileName, e);
            return null;
        }
    }
    
    /**
     * Capture screenshot for test method
     * @param testMethodName Test method name
     * @return Screenshot file path
     */
    public static String captureTestScreenshot(String testMethodName) {
        String fileName = "test_" + testMethodName + "_" + getCurrentTimestamp();
        return captureScreenshot(fileName);
    }
    
    /**
     * Capture screenshot for failed test
     * @param testMethodName Test method name
     * @return Screenshot file path
     */
    public static String captureFailureScreenshot(String testMethodName) {
        String fileName = "FAILED_" + testMethodName + "_" + getCurrentTimestamp();
        Log.info("Capturing failure screenshot for: " + testMethodName);
        return captureScreenshot(fileName);
    }
    
    /**
     * Capture screenshot for test step
     * @param testMethodName Test method name
     * @param stepDescription Step description
     * @return Screenshot file path
     */
    public static String captureStepScreenshot(String testMethodName, String stepDescription) {
        String sanitizedStep = stepDescription.replaceAll("[^a-zA-Z0-9]", "_");
        String fileName = "step_" + testMethodName + "_" + sanitizedStep + "_" + getCurrentTimestamp();
        return captureScreenshot(fileName);
    }
    
    /**
     * Get current timestamp for file naming
     * @return Formatted timestamp string
     */
    private static String getCurrentTimestamp() {
        return LocalDateTime.now().format(TIMESTAMP_FORMAT);
    }
    
    /**
     * Get screenshots directory path
     * @return Screenshots directory path
     */
    public static String getScreenshotDirectory() {
        return SCREENSHOT_DIR;
    }
    
    /**
     * Clean up old screenshots (older than specified days)
     * @param daysOld Number of days to keep screenshots
     */
    public static void cleanupOldScreenshots(int daysOld) {
        try {
            File screenshotDir = new File(SCREENSHOT_DIR);
            if (!screenshotDir.exists()) {
                return;
            }
            
            File[] files = screenshotDir.listFiles();
            if (files == null) {
                return;
            }
            
            long cutoffTime = System.currentTimeMillis() - (daysOld * 24L * 60L * 60L * 1000L);
            int deletedCount = 0;
            
            for (File file : files) {
                if (file.isFile() && file.getName().endsWith(".png") && 
                    file.lastModified() < cutoffTime) {
                    if (file.delete()) {
                        deletedCount++;
                    }
                }
            }
            
            if (deletedCount > 0) {
                Log.info("Cleaned up " + deletedCount + " old screenshots");
            }
            
        } catch (Exception e) {
            Log.error("Error cleaning up old screenshots", e);
        }
    }
    
    /**
     * Get relative path for ExtentReports
     * @param absolutePath Absolute file path
     * @return Relative path for reports
     */
    public static String getRelativePath(String absolutePath) {
        if (absolutePath == null) {
            return null;
        }
        
        String userDir = System.getProperty("user.dir");
        if (absolutePath.startsWith(userDir)) {
            return absolutePath.substring(userDir.length() + 1).replace("\\", "/");
        }
        
        return absolutePath;
    }
    
    /**
     * Check if screenshot capture is supported
     * @return true if WebDriver supports screenshot capture
     */
    public static boolean isScreenshotSupported() {
        try {
            WebDriver driver = DriverManager.getDriver();
            return driver != null && driver instanceof TakesScreenshot;
        } catch (Exception e) {
            return false;
        }
    }
}