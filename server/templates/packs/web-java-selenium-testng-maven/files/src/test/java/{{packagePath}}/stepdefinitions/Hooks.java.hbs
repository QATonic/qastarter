package {{javaPackage}}.stepdefinitions;

import {{javaPackage}}.core.DriverManager;
import {{javaPackage}}.utils.Log;
import {{javaPackage}}.utils.ScreenshotUtils;
{{#if (eq reportingTool "allure")}}
import {{javaPackage}}.utils.AllureManager;
{{/if}}
{{#if (eq reportingTool "extent-reports")}}
import {{javaPackage}}.utils.ExtentManager;
{{/if}}
import io.cucumber.java.After;
import io.cucumber.java.AfterStep;
import io.cucumber.java.Before;
import io.cucumber.java.Scenario;
import org.openqa.selenium.WebDriver;

/**
 * Cucumber Hooks for setup and teardown
 * Manages WebDriver lifecycle and reporting
 */
public class Hooks {

    private WebDriver driver;

    /**
     * Before each scenario
     * Initialize WebDriver and reporting
     * @param scenario Cucumber scenario
     */
    @Before
    public void setUp(Scenario scenario) {
        Log.info("===== Starting Scenario: " + scenario.getName() + " =====");
        Log.info("Tags: " + scenario.getSourceTagNames());
        
        // Initialize WebDriver
        DriverManager.initializeDriver();
        driver = DriverManager.getDriver();
        Log.info("WebDriver initialized successfully");
{{#if (eq reportingTool "extent-reports")}}
        
        // Initialize ExtentReports test
        ExtentManager.createTest(scenario.getName(), "BDD Scenario");
        ExtentManager.logInfo("Scenario started: " + scenario.getName());
        for (String tag : scenario.getSourceTagNames()) {
            ExtentManager.addCategory(tag);
        }
{{/if}}
{{#if (eq reportingTool "allure")}}
        
        // Add Allure labels
        AllureManager.addCategory(scenario.getName());
        for (String tag : scenario.getSourceTagNames()) {
            AllureManager.addFeature(tag);
        }
{{/if}}
    }

    /**
     * After each step
     * Capture screenshot on failure
     * @param scenario Cucumber scenario
     */
    @AfterStep
    public void afterStep(Scenario scenario) {
        // Take screenshot if step failed
        if (scenario.isFailed()) {
            Log.error("Step failed: " + scenario.getName());
            
            try {
                String screenshotPath = ScreenshotUtils.captureScreenshot(
                    driver, 
                    "Failed_Step_" + System.currentTimeMillis()
                );
                Log.info("Screenshot captured: " + screenshotPath);
{{#if (eq reportingTool "extent-reports")}}
                
                ExtentManager.attachScreenshotFile(screenshotPath, "Failed Step Screenshot");
                ExtentManager.logFail("Step failed - Screenshot captured");
{{/if}}
{{#if (eq reportingTool "allure")}}
                
                AllureManager.attachScreenshot(driver, "Failed Step Screenshot");
{{/if}}
                
                // Embed screenshot in Cucumber report
                byte[] screenshot = ScreenshotUtils.getScreenshotAsBytes(driver);
                scenario.attach(screenshot, "image/png", "Failed Step Screenshot");
            } catch (Exception e) {
                Log.error("Failed to capture screenshot", e);
            }
        }
    }

    /**
     * After each scenario
     * Quit WebDriver and finalize reporting
     * @param scenario Cucumber scenario
     */
    @After
    public void tearDown(Scenario scenario) {
        try {
            // Take final screenshot if scenario failed
            if (scenario.isFailed()) {
                Log.error("Scenario failed: " + scenario.getName());
                
                try {
                    String screenshotPath = ScreenshotUtils.captureScreenshot(
                        driver,
                        "Failed_Scenario_" + scenario.getName() + "_" + System.currentTimeMillis()
                    );
                    Log.info("Final screenshot captured: " + screenshotPath);
{{#if (eq reportingTool "extent-reports")}}
                    
                    ExtentManager.attachScreenshotFile(screenshotPath, "Scenario Failure Screenshot");
                    ExtentManager.logFail("Scenario failed: " + scenario.getName());
{{/if}}
{{#if (eq reportingTool "allure")}}
                    
                    AllureManager.attachScreenshot(driver, "Scenario Failure Screenshot");
{{/if}}
                    
                    // Embed in Cucumber report
                    byte[] screenshot = ScreenshotUtils.getScreenshotAsBytes(driver);
                    scenario.attach(screenshot, "image/png", "Scenario Failure Screenshot");
                } catch (Exception e) {
                    Log.error("Failed to capture final screenshot", e);
                }
            } else {
                Log.info("Scenario passed: " + scenario.getName());
{{#if (eq reportingTool "extent-reports")}}
                ExtentManager.logPass("Scenario passed: " + scenario.getName());
{{/if}}
            }
{{#if (eq reportingTool "extent-reports")}}
            
            // Remove test from ThreadLocal
            ExtentManager.removeTest();
{{/if}}
        } finally {
            // Quit WebDriver
            DriverManager.quitDriver();
            Log.info("===== Finished Scenario: " + scenario.getName() + " =====\n");
        }
    }
}
