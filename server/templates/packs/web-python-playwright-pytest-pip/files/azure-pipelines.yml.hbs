trigger:
  branches:
    include:
      - main
      - develop

pr:
  branches:
    include:
      - main

pool:
  vmImage: 'ubuntu-latest'

variables:
  PYTHON_VERSION: '{{toolVersions.python}}'
  TEST_ENV: 'qa'
  HEADLESS: 'true'

strategy:
  matrix:
    chromium:
      BROWSER: 'chromium'
    firefox:
      BROWSER: 'firefox'

steps:
- task: UsePythonVersion@0
  inputs:
    versionSpec: '$(PYTHON_VERSION)'
  displayName: 'Set up Python $(PYTHON_VERSION)'

- script: |
    python -m pip install --upgrade pip
    pip install -r requirements.txt
  displayName: 'Install dependencies'

- script: |
    playwright install --with-deps $(BROWSER)
  displayName: 'Install Playwright browsers'

- script: |
    pytest -v -n auto --browser $(BROWSER)
  displayName: 'Run tests'
  env:
    BROWSER: $(BROWSER)
    TEST_ENV: $(TEST_ENV)
    HEADLESS: $(HEADLESS)

{{#if (eq reportingTool "allure")}}
- script: |
    wget https://github.com/allure-framework/allure2/releases/download/2.25.0/allure-2.25.0.tgz
    tar -zxvf allure-2.25.0.tgz -C /opt/
    sudo ln -s /opt/allure-2.25.0/bin/allure /usr/local/bin/allure
  displayName: 'Install Allure CLI'
  condition: always()

- script: |
    allure generate allure-results --clean -o allure-report
  displayName: 'Generate Allure report'
  condition: always()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'allure-results'
    ArtifactName: 'allure-results-$(BROWSER)'
    publishLocation: 'Container'
  displayName: 'Publish Allure results'
  condition: always()

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'allure-report'
    ArtifactName: 'allure-report-$(BROWSER)'
    publishLocation: 'Container'
  displayName: 'Publish Allure report'
  condition: always()
{{/if}}

{{#if (eq reportingTool "pytest-html")}}
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/report.html'
    ArtifactName: 'pytest-html-report-$(BROWSER)'
    publishLocation: 'Container'
  displayName: 'Publish Pytest HTML report'
  condition: always()
{{/if}}

{{#if (eq reportingTool "pytest-json-report")}}
- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'reports/report.json'
    ArtifactName: 'pytest-json-report-$(BROWSER)'
    publishLocation: 'Container'
  displayName: 'Publish Pytest JSON report'
  condition: always()
{{/if}}

- task: PublishBuildArtifacts@1
  inputs:
    PathtoPublish: 'screenshots'
    ArtifactName: 'screenshots-$(BROWSER)'
    publishLocation: 'Container'
  displayName: 'Publish screenshots'
  condition: failed()
