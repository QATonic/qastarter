"""
Pytest fixtures for setup/teardown and driver management
"""
import pytest
from selenium.webdriver.remote.webdriver import WebDriver
from utils.driver_factory import DriverFactory
from utils.screenshot_util import ScreenshotUtil
from utils.logger import Logger
from config.config import Config

logger = Logger.get_logger(__name__)

@pytest.fixture(scope="function")
def driver(request) -> WebDriver:
    """
    WebDriver fixture with automatic cleanup
    
    Usage:
        def test_example(driver):
            driver.get("https://example.com")
    """
    logger.info("Setting up WebDriver")
    driver_instance = DriverFactory.create_driver()
    driver_instance.implicitly_wait(Config.IMPLICIT_WAIT)
    
    yield driver_instance
    
    # Capture screenshot on failure
    if request.node.rep_call.failed and Config.SCREENSHOT_ON_FAILURE:
        screenshot_util = ScreenshotUtil(driver_instance)
        test_name = request.node.name
        screenshot_path = screenshot_util.capture_screenshot(f"failed_{test_name}")
        logger.error(f"Test failed. Screenshot saved: {screenshot_path}")
    
    logger.info("Tearing down WebDriver")
    driver_instance.quit()

@pytest.fixture(scope="session", autouse=True)
def setup_directories():
    """Create necessary directories"""
    Config.SCREENSHOT_DIR.mkdir(exist_ok=True)
    Config.LOG_DIR.mkdir(exist_ok=True)
    Config.REPORT_DIR.mkdir(exist_ok=True)

@pytest.hookimpl(tryfirst=True, hookwrapper=True)
def pytest_runtest_makereport(item, call):
    """Hook to capture test result for screenshot on failure"""
    outcome = yield
    rep = outcome.get_result()
    setattr(item, f"rep_{rep.when}", rep)
