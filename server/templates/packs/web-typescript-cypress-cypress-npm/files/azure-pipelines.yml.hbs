trigger:
  branches:
    include:
      - main
      - develop

pool:
  vmImage: 'ubuntu-latest'

variables:
  NODE_VERSION: '{{toolVersions.node}}'
  TEST_ENV: 'qa'
  CYPRESS_CACHE_FOLDER: $(Pipeline.Workspace)/.cypress-cache

strategy:
  matrix:
    chrome:
      BROWSER: 'chrome'
    firefox:
      BROWSER: 'firefox'

steps:
  - task: NodeTool@0
    inputs:
      versionSpec: '{{toolVersions.node}}'
    displayName: 'Install Node.js {{toolVersions.node}}'

  - task: Cache@2
    inputs:
      key: 'cypress | "$(Agent.OS)" | package-lock.json'
      path: $(CYPRESS_CACHE_FOLDER)
    displayName: 'Cache Cypress binary'

  - script: npm ci
    displayName: 'Install dependencies'

  - script: npx cypress install
    displayName: 'Install Cypress'

  - script: npx cypress run --browser $(BROWSER)
    displayName: 'Run Cypress tests'
    env:
      TEST_ENV: $(TEST_ENV)

{{#if (eq reportingTool "allure")}}
  - script: npm run report:generate
    displayName: 'Generate Allure Report'
    condition: always()

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Results'
    condition: always()
    inputs:
      PathtoPublish: 'allure-results'
      ArtifactName: 'allure-results-$(BROWSER)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Allure Report'
    condition: always()
    inputs:
      PathtoPublish: 'allure-report'
      ArtifactName: 'allure-report-$(BROWSER)'
{{/if}}

{{#if (eq reportingTool "mochawesome")}}
  - task: PublishBuildArtifacts@1
    displayName: 'Publish Mochawesome Report'
    condition: always()
    inputs:
      PathtoPublish: 'cypress/reports'
      ArtifactName: 'mochawesome-report-$(BROWSER)'
{{/if}}

{{#if (eq reportingTool "junit")}}
  - task: PublishTestResults@2
    displayName: 'Publish JUnit Test Results'
    condition: always()
    inputs:
      testResultsFormat: 'JUnit'
      testResultsFiles: 'cypress/results/junit-*.xml'
      testRunTitle: 'Cypress Tests - $(BROWSER)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish JUnit Reports'
    condition: always()
    inputs:
      PathtoPublish: 'cypress/results'
      ArtifactName: 'junit-reports-$(BROWSER)'
{{/if}}

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Videos'
    condition: always()
    inputs:
      PathtoPublish: 'cypress/videos'
      ArtifactName: 'videos-$(BROWSER)'

  - task: PublishBuildArtifacts@1
    displayName: 'Publish Screenshots'
    condition: failed()
    inputs:
      PathtoPublish: 'cypress/screenshots'
      ArtifactName: 'screenshots-$(BROWSER)'
